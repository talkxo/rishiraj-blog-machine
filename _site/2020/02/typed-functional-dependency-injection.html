<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Favicon -->
  <link rel="apple-touch-icon" sizes="57x57" href="/assets/images/favicons/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/assets/images/favicons/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/assets/images/favicons/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/assets/images/favicons/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/assets/images/favicons/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/assets/images/favicons/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/assets/images/favicons/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/assets/images/favicons/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/images/favicons/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192"  href="/assets/images/favicons/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/assets/images/favicons/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/images/favicons/manifest.json">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/assets/images/favicons/ms-icon-144x144.png">
<meta name="theme-color" content="#ffffff">


  <!-- Meta information -->
  <title>Typed functional Dependency Injection in Python</title>
  <meta name="description"
        content="">
  <link rel="canonical"
        href="http://localhost:4000/2020/02/typed-functional-dependency-injection" />

  <!-- Open search scheme -->
  <link rel="search"
        type="application/opensearchdescription+xml"
        title="sobolevn.me"
        href="/opensearch.xml" />

  <!-- Feed -->
  <link rel="alternate" type="application/rss+xml" title="rishi raj's blog"
        href="/feed.xml" />

  <!-- Custom fonts -->
  <link href="https://fonts.googleapis.com/css?family=Merriweather:400,400i,900|Roboto+Mono:400,400i|Montserrat:400,800" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">

  <!-- Custom style -->
  <link rel="stylesheet" href="/css/main.css" />

  <!-- Global site tag (gtag.js) - Google Ads: 839642990 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=AW-839642990"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'AW-839642990');
  </script>
</head>


  <body>
    <main class="u-container">
      <div class="c-page">
  <header class="c-page__header">
  <h1><code>rishi raj's blog</code></h1>

  

  <nav role="navigation">
    <a href="/" role="menuitem">
      Blog
    </a>

    <span class="u-separate"></span>
    <a href="/talks/" role="menuitem">
      Talks
    </a>

    <span class="u-separate"></span>
    <a href="/activities/" role="menuitem">
      Activities
    </a>

    <span class="u-separate"></span>
    <a href="/about/" role="menuitem">
      About
    </a>

    <span class="u-separate"></span>
    <a href="/subscribe/" role="menuitem">
      Subscribe
    </a>
  </nav>
</header>

  <div class="c-page__main">
    <article class="c-article" itemscope="" itemtype="http://schema.org/BlogPosting">
  <header class="c-article__header">
    <h1 class="c-article__title" itemprop="name">Typed functional Dependency Injection in Python</h1>
    <p class="c-article__time">
      <small>
        <time datetime="2020-02-02T00:00:00+05:30" itemprop="datePublished">
          February 2, 2020
        </time>
      </small>
      <small><span class="reading-time" title="Estimated read time">
  
  
    19 mins
   read
</span>
</small>
      <small><a href="#discussion">Start a discussion</a></small>
      <small><a href="https://github.com/sobolevn/sobolevn.github.io/blob/master/_posts/2020-02-02-typed-functional-dependency-injection.md">Edit this page</a></small>
    </p>
  </header>

  <!-- Post Tags -->
  <!-- <ul class="c-tags">
    
    <li class="c-tag">python</li>
    
  </ul> -->

  <!-- Content -->
  <div class="c-article__main">

    
      
      
    

    <div class="c-article__body" itemprop="articleBody">
      <p><img src="https://dev-to-uploads.s3.amazonaws.com/i/icaf8zy973836hf4dh8j.png" alt="Cover image"></p>

<p>Dependency injection is a controversial topic. There are known problems, hacks, and even whole methodologies on how to work with DI frameworks.</p>

<p>A lot of people asked me: how can you use a lot of typed functional concepts together with <a href="https://sobolevn.me/2019/03/enforcing-srp">traditional object-oriented dependency injection</a>?</p>

<p>And this question makes a lot of sense. Because functional programming is all about composition. And dependency injection is just magic. You get some almost random objects injected into some places of your code. Moreover, the whole container to be injected later is magically assembled from the separate parts at runtime.</p>

<p>This leads to a serious contradiction between functional declarative style and “OMG, where did this class come from?”</p>

<p><img src="https://dev-to-uploads.s3.amazonaws.com/i/it0fk0jbqphcgecnpbq7.jpg" alt="DI meme"></p>

<p>Today we are going to solve this problem with a good-old functional way.</p>


      <h2 id="regular-functions">
        
        <a class="anchor" href="#regular-functions">Regular functions</a>
        
      </h2>

<p>Imagine that you have a <code class="language-plaintext highlighter-rouge">django</code> based game, where you award users with points for each guessed letter in a word (unguessed letters are marked as <code class="language-plaintext highlighter-rouge">'.'</code>):</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpRequest</span><span class="p">,</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">words_app.logic</span> <span class="kn">import</span> <span class="n">calculate_points</span>

<span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="n">user_word</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">POST</span><span class="p">[</span><span class="s">'word'</span><span class="p">]</span>  <span class="c1"># just an example
</span>    <span class="n">points</span> <span class="o">=</span> <span class="n">calculate_points</span><span class="p">(</span><span class="n">user_word</span><span class="p">)</span>
    <span class="p">...</span>  <span class="c1"># later you show the result to user somehow
</span></code></pre></div></div>

<p>And here’s your business logic:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Somewhere in your `words_app/logic.py`:
</span>
<span class="k">def</span> <span class="nf">calculate_points</span><span class="p">(</span><span class="n">word</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">guessed_letters_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">letter</span> <span class="k">for</span> <span class="n">letter</span> <span class="ow">in</span> <span class="n">word</span> <span class="k">if</span> <span class="n">letter</span> <span class="o">!=</span> <span class="s">'.'</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">_award_points_for_letters</span><span class="p">(</span><span class="n">guessed_letters_count</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_award_points_for_letters</span><span class="p">(</span><span class="n">guessed</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">guessed</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="k">else</span> <span class="n">guessed</span>  <span class="c1"># minimum 6 points possible!
</span></code></pre></div></div>

<p>This is a pretty simple app: users try to guess some word and in the meantime, we award points for each guessed letter. But, we have a threshold. We only award 6 or more points for 6 or more guessed letters. That’s it. We have our framework layer in place and our beautiful pure logic. This code is really simple to read and modify.</p>

<p>Or is it? Let’s try to modify it to find out. Let’s say we want to make our game more challenging by making the points threshold configurable. How can we do that?</p>


    
      <h2 id="naive-attempt">
        
        <a class="anchor" href="#naive-attempt">Naive attempt</a>
        
      </h2>

<p>Ok, let’s make <code class="language-plaintext highlighter-rouge">_award_points_for_letters</code> accept the second argument <code class="language-plaintext highlighter-rouge">threshold: int</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_award_points_for_letters</span><span class="p">(</span><span class="n">guessed</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">guessed</span> <span class="o">&lt;</span> <span class="n">threshold</span> <span class="k">else</span> <span class="n">guessed</span>
</code></pre></div></div>

<p>And now your code won’t type-check. Because that’s how our caller looks like:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">calculate_points</span><span class="p">(</span><span class="n">word</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="c1"># ...
</span>    <span class="k">return</span> <span class="n">_award_points_for_letters</span><span class="p">(</span><span class="n">guessed_letters_count</span><span class="p">)</span>
</code></pre></div></div>

<p>To fix this <code class="language-plaintext highlighter-rouge">calculate_points</code> function (and all other upper caller functions) will have to accept <code class="language-plaintext highlighter-rouge">threshold: int</code> as a parameter and pass it to <code class="language-plaintext highlighter-rouge">_award_points_for_letters</code>, like so:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">calculate_points</span><span class="p">(</span><span class="n">word</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="c1"># ...
</span>    <span class="k">return</span> <span class="n">_award_points_for_letters</span><span class="p">(</span><span class="n">guessed_letters_count</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>
</code></pre></div></div>

<p>It also affects our <code class="language-plaintext highlighter-rouge">views.py</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpRequest</span><span class="p">,</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">words_app.logic</span> <span class="kn">import</span> <span class="n">calculate_points</span>

<span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="n">user_word</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">POST</span><span class="p">[</span><span class="s">'word'</span><span class="p">]</span>  <span class="c1"># just an example
</span>    <span class="n">points</span> <span class="o">=</span> <span class="n">calculate_points</span><span class="p">(</span><span class="n">user_word</span><span class="p">,</span> <span class="n">settings</span><span class="p">.</span><span class="n">WORD_THRESHOLD</span><span class="p">)</span>
    <span class="p">...</span>  <span class="c1"># later you show the result to user somehow
</span></code></pre></div></div>

<p>As we can see it is doable. But, it requires to change the whole call stack for a single parameter. Which leads us to some evident problems:</p>

<ul>
  <li>If our call stack is big, we will have to modify lots of layers to achieve the place where we really need this value</li>
  <li>All our functions and classes will be infected with the values we pass. This would have several effects: you won’t be able to understand which functions and classes really need passed values and which are just work as a transport layer (like <code class="language-plaintext highlighter-rouge">calculate_points</code> in our example). And of course, people would start using these passed values where they need them. And this will implicitly increase the coupling of your code and environment.</li>
  <li>It would be hard to compose your functions and classes together. This extra parameter will always get in the way. Arities of your functions would not match.</li>
</ul>

<p>All in all: this is working, but not a scalable solution. But, I would probably do this myself for a small app.</p>


    
      <h2 id="frameworks">
        
        <a class="anchor" href="#frameworks">Frameworks</a>
        
      </h2>

<p>A lot of Django people right now might ask: why not just importing settings and using it like <code class="language-plaintext highlighter-rouge">django</code> docs teaches us?</p>

<p>Because this is <strong>ugly</strong>!</p>

<p>For now, we have framework-independent business logic. It is a great thing. It is resistant to any framework-specific changes. And it also does not implicitly bring all the framework complexity with it. Let’s remember how <code class="language-plaintext highlighter-rouge">django.conf.settings</code> works:</p>

<ol>
  <li>We need to set <code class="language-plaintext highlighter-rouge">DJANGO_SETTINGS_MODULE</code> env variable to find the settings module</li>
  <li>Somewhere deep inside the framework <code class="language-plaintext highlighter-rouge">django.setup()</code> will happen</li>
  <li>
<code class="language-plaintext highlighter-rouge">django</code> will import this module</li>
  <li>This module might contain <a href="https://sobolevn.me/2017/04/managing-djangos-settings">settings-dependent logic</a>
</li>
  <li>Settings will also access environment, files, maybe even cloud providers for some specific values</li>
  <li>Then <code class="language-plaintext highlighter-rouge">django</code> will have almost-immutable singleton object that you can import from any place in your code</li>
  <li>You will have to mock settings in your tests to simply pass other value to your function. Or multiple (and many more) values if you heavily rely on settings module (which will probably be the case in any app)</li>
</ol>

<p>Is it worth it? Maybe. Sometimes <code class="language-plaintext highlighter-rouge">django.settings</code> is good enough. You can possibly have just a couple of primitive values to be injected. And this way allows to do it very fast.</p>

<p>But, I would not recommend anyone to go this way if you really want to build a large app with clearly defined boundaries and comprehensive domain logic. I would even recommend using <a href="https://import-linter.readthedocs.io/"><code class="language-plaintext highlighter-rouge">import-linter</code></a> to forbid to import anything from <code class="language-plaintext highlighter-rouge">django</code> in your logic.</p>

<p>So, how in a world I am going to pass this troublesome value into the function if nothing really works? Parameters are too noisy, containers are too magic and hard to work with, and global settings are just pure evil in the form of a singleton?</p>


    
      <h2 id="composition">
        
        <a class="anchor" href="#composition">Composition</a>
        
      </h2>

<p>Functional programmers are smart people. Really. They can do literally everything with just pure functions.</p>

<p><a href="https://vimeo.com/113588389"><img src="https://dev-to-uploads.s3.amazonaws.com/i/e0kjtxmcsotbgj3plqok.gif" alt="Functional patterns"></a></p>

<p>They have also solved the dependencies problem with elegance while maintaining simplicity. The core idea of dependency injection in a functional way is that we don’t call things that rely on the context we don’t have. Instead, we schedule them to be called later. Let’s see how our original logic will change after adapting this idea:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span>
<span class="kn">from</span> <span class="nn">typing_extensions</span> <span class="kn">import</span> <span class="n">Protocol</span>

<span class="k">class</span> <span class="nc">_Deps</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>  <span class="c1"># we rely on abstractions, not direct values or types
</span>    <span class="n">WORD_THRESHOLD</span><span class="p">:</span> <span class="nb">int</span>

<span class="k">def</span> <span class="nf">calculate_points</span><span class="p">(</span><span class="n">word</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">_Deps</span><span class="p">],</span> <span class="nb">int</span><span class="p">]:</span>
    <span class="n">guessed_letters_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">letter</span> <span class="k">for</span> <span class="n">letter</span> <span class="ow">in</span> <span class="n">word</span> <span class="k">if</span> <span class="n">letter</span> <span class="o">!=</span> <span class="s">'.'</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">_award_points_for_letters</span><span class="p">(</span><span class="n">guessed_letters_count</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_award_points_for_letters</span><span class="p">(</span><span class="n">guessed</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">_Deps</span><span class="p">],</span> <span class="nb">int</span><span class="p">]:</span>
    <span class="k">def</span> <span class="nf">factory</span><span class="p">(</span><span class="n">deps</span><span class="p">:</span> <span class="n">_Deps</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">guessed</span> <span class="o">&lt;</span> <span class="n">deps</span><span class="p">.</span><span class="n">WORD_THRESHOLD</span> <span class="k">else</span> <span class="n">guessed</span>
    <span class="k">return</span> <span class="n">factory</span>
</code></pre></div></div>

<p>Please, notice how we are now passing <code class="language-plaintext highlighter-rouge">factory</code> function to the top level of our app. Also, pay extra attention to our new <code class="language-plaintext highlighter-rouge">_Deps</code> <a href="https://mypy.readthedocs.io/en/stable/protocols.html">protocol</a>: it allows us to use structural subtyping to define the required API. In other words, all objects with <code class="language-plaintext highlighter-rouge">WORD_THRESHOLD</code> <code class="language-plaintext highlighter-rouge">int</code> attribute would pass the check (to enforce the <code class="language-plaintext highlighter-rouge">django</code> settings typecheck use <a href="https://github.com/typeddjango/django-stubs"><code class="language-plaintext highlighter-rouge">django-stubs</code></a>).</p>

<p>The only thing left is to call our returned <code class="language-plaintext highlighter-rouge">factory</code> function from the very top:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpRequest</span><span class="p">,</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">words_app.logic</span> <span class="kn">import</span> <span class="n">calculate_points</span>

<span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
    <span class="n">user_word</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">POST</span><span class="p">[</span><span class="s">'word'</span><span class="p">]</span>  <span class="c1"># just an example
</span>    <span class="n">points</span> <span class="o">=</span> <span class="n">calculate_points</span><span class="p">(</span><span class="n">user_words</span><span class="p">)(</span><span class="n">settings</span><span class="p">)</span>  <span class="c1"># passing the dependencies and calling
</span>    <span class="p">...</span>  <span class="c1"># later you show the result to user somehow
</span></code></pre></div></div>

<p>Looks easy! All our requirements are satisfied:</p>

<ol>
  <li>We don’t have any magic, literally zero</li>
  <li>Everything is typed properly</li>
  <li>Our logic is still pure and is independent from the framework</li>
</ol>

<p>The only problem we now have is that our logic does not compose well. Let me illustrate my point with a new requirement. During the holiday season our game might award one extra point to the final score randomly. And here’s how we can adapt our source code to meet the new requirement:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">calculate_points</span><span class="p">(</span><span class="n">word</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">_Deps</span><span class="p">],</span> <span class="nb">int</span><span class="p">]:</span>
    <span class="n">guessed_letters_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">letter</span> <span class="k">for</span> <span class="n">letter</span> <span class="ow">in</span> <span class="n">word</span> <span class="k">if</span> <span class="n">letter</span> <span class="o">!=</span> <span class="s">'.'</span><span class="p">])</span>
    <span class="n">awarded_points</span> <span class="o">=</span> <span class="n">_award_points_for_letters</span><span class="p">(</span><span class="n">guessed_letters_count</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_maybe_add_extra_holiday_point</span><span class="p">(</span><span class="n">awarded_points</span><span class="p">)</span>  <span class="c1"># won't work :(
</span>
<span class="k">def</span> <span class="nf">_maybe_add_extra_holiday_point</span><span class="p">(</span><span class="n">awarded_points</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">awarded_points</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">random</span><span class="p">.</span><span class="n">choice</span><span class="p">([</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">])</span> <span class="k">else</span> <span class="n">awarded_points</span>
</code></pre></div></div>

<p>But, oops, <code class="language-plaintext highlighter-rouge">awarded_points</code> has type <code class="language-plaintext highlighter-rouge">Callable[[_Deps], int]</code> it cannot be easily composed with this new function. Of course we can create a new function inside <code class="language-plaintext highlighter-rouge">_maybe_add_extra_holiday_point</code> just for the sake of composition:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_maybe_add_extra_holiday_point</span><span class="p">(</span><span class="n">awarded_points</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">_Deps</span><span class="p">],</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">_Deps</span><span class="p">],</span> <span class="nb">int</span><span class="p">]:</span>
    <span class="k">def</span> <span class="nf">factory</span><span class="p">(</span><span class="n">deps</span><span class="p">:</span> <span class="n">_Deps</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">awarded_points</span><span class="p">(</span><span class="n">deps</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">points</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">random</span><span class="p">.</span><span class="n">choice</span><span class="p">([</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">])</span> <span class="k">else</span> <span class="n">points</span>
    <span class="k">return</span> <span class="n">factory</span>
</code></pre></div></div>

<p>But is it pleasant to work with? I hope most people will agree with me that it is not.</p>

<p>Let’s remember that functional programmers are smart people. They can do literally everything with just pure functions. And composition helpers. That’s why they came up with the <code class="language-plaintext highlighter-rouge">Reader</code> monad (or as we call it <a href="https://returns.readthedocs.io/en/latest/pages/context.html"><code class="language-plaintext highlighter-rouge">RequiresContext</code> container</a> to not scare people to death in Python land): it is a composition helper for this exact situation. Let’s refactor our code once again to see how it works:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">typing_extensions</span> <span class="kn">import</span> <span class="n">Protocol</span>
<span class="kn">from</span> <span class="nn">returns.context</span> <span class="kn">import</span> <span class="n">RequiresContext</span>

<span class="k">class</span> <span class="nc">_Deps</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>  <span class="c1"># we rely on abstractions, not direct values or types
</span>    <span class="n">WORD_THRESHOLD</span><span class="p">:</span> <span class="nb">int</span>

<span class="k">def</span> <span class="nf">calculate_points</span><span class="p">(</span><span class="n">word</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RequiresContext</span><span class="p">[</span><span class="n">_Deps</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
    <span class="n">guessed_letters_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">letter</span> <span class="k">for</span> <span class="n">letter</span> <span class="ow">in</span> <span class="n">word</span> <span class="k">if</span> <span class="n">letter</span> <span class="o">!=</span> <span class="s">'.'</span><span class="p">])</span>
    <span class="n">awarded_points</span> <span class="o">=</span> <span class="n">_award_points_for_letters</span><span class="p">(</span><span class="n">guessed_letters_count</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">awarded_points</span><span class="p">.</span><span class="nb">map</span><span class="p">(</span><span class="n">_maybe_add_extra_holiday_point</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_award_points_for_letters</span><span class="p">(</span><span class="n">guessed</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RequiresContext</span><span class="p">[</span><span class="n">_Deps</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
    <span class="k">def</span> <span class="nf">factory</span><span class="p">(</span><span class="n">deps</span><span class="p">:</span> <span class="n">_Deps</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">guessed</span> <span class="o">&lt;</span> <span class="n">deps</span><span class="p">.</span><span class="n">WORD_THRESHOLD</span> <span class="k">else</span> <span class="n">guessed</span>
    <span class="k">return</span> <span class="n">RequiresContext</span><span class="p">(</span><span class="n">factory</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_maybe_add_extra_holiday_point</span><span class="p">(</span><span class="n">awarded_points</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">awarded_points</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">random</span><span class="p">.</span><span class="n">choice</span><span class="p">([</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">])</span> <span class="k">else</span> <span class="n">awarded_points</span>
</code></pre></div></div>

<p>We have changed the return type of the functions and we have also added <code class="language-plaintext highlighter-rouge">awarded_points.map(_maybe_add_extra_holiday_point)</code>. Which is another way of saying “compose <code class="language-plaintext highlighter-rouge">RequiresContext</code> container with this pure function <code class="language-plaintext highlighter-rouge">_maybe_add_extra_holiday_point</code>”. We don’t change our framework layer at all.</p>

<p>How does it work?</p>

<ol>
  <li>When we call <code class="language-plaintext highlighter-rouge">calculate_points(user_words)</code> it does not actually start to do anything, it only returns <code class="language-plaintext highlighter-rouge">RequiresContext</code> container to be called later</li>
  <li>The container is smart enough to understand the <code class="language-plaintext highlighter-rouge">.map</code> method. It remembers that after its execution it will need to call <code class="language-plaintext highlighter-rouge">_maybe_add_extra_holiday_point</code> function</li>
  <li>When we add the context to the container in a form of <code class="language-plaintext highlighter-rouge">calculate_points(user_words)(settings)</code> our <code class="language-plaintext highlighter-rouge">def factory(deps: _Deps)</code> executes and returns the long-awaited value</li>
  <li>Then <code class="language-plaintext highlighter-rouge">_maybe_add_extra_holiday_point</code> actually executes and returns the final value</li>
</ol>

<p>That’s it. No mess, no magic, no framework internals. But typing, composition, and simplicity.</p>


    
      <h2 id="transparent-dependencies">
        
        <a class="anchor" href="#transparent-dependencies">Transparent dependencies</a>
        
      </h2>

<p>What if you want to also change the symbol that indicates unguessed letter (currently <code class="language-plaintext highlighter-rouge">.</code>), to be configurable? Some users prefer <code class="language-plaintext highlighter-rouge">.</code>, some <code class="language-plaintext highlighter-rouge">_</code>. Ok, we can do that, cannot we?</p>

<p>A little confusion can happen to functional newcomers at this step. Because we only have <code class="language-plaintext highlighter-rouge">deps</code> available inside <code class="language-plaintext highlighter-rouge">_award_points_for_letters</code> and not inside <code class="language-plaintext highlighter-rouge">calculate_points</code>. And composition again is the answer. We have a special composition helper for this case: <a href="https://returns.readthedocs.io/en/latest/pages/context.html#returns.context.requires_context.Context.ask"><code class="language-plaintext highlighter-rouge">Context.ask()</code></a> which fetches the dependencies from the current context and allows us to explicitly use it whenever we want:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">returns.context</span> <span class="kn">import</span> <span class="n">Context</span><span class="p">,</span> <span class="n">RequiresContext</span>

<span class="k">class</span> <span class="nc">_Deps</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>  <span class="c1"># we rely on abstractions, not direct values or types
</span>    <span class="n">WORD_THRESSHOLD</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">UNGUESSED_CHAR</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># new value!
</span>
<span class="k">def</span> <span class="nf">calculate_points</span><span class="p">(</span><span class="n">word</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RequiresContext</span><span class="p">[</span><span class="n">_Deps</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
    <span class="k">def</span> <span class="nf">factory</span><span class="p">(</span><span class="n">deps</span><span class="p">:</span> <span class="n">_Deps</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RequiresContext</span><span class="p">[</span><span class="n">_Deps</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="n">guessed_letters_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span>
            <span class="n">letter</span> <span class="k">for</span> <span class="n">letter</span> <span class="ow">in</span> <span class="n">word</span> <span class="k">if</span> <span class="n">letter</span> <span class="o">!=</span> <span class="n">deps</span><span class="p">.</span><span class="n">UNGUESSED_CHAR</span>
        <span class="p">])</span>
        <span class="n">awarded_points</span> <span class="o">=</span> <span class="n">_award_points_for_letters</span><span class="p">(</span><span class="n">guessed_letters_count</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">awarded_points</span><span class="p">.</span><span class="nb">map</span><span class="p">(</span><span class="n">_maybe_add_extra_holiday_point</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Context</span><span class="p">[</span><span class="n">_Deps</span><span class="p">].</span><span class="n">ask</span><span class="p">().</span><span class="n">bind</span><span class="p">(</span><span class="n">factory</span><span class="p">)</span>

<span class="c1"># ...
</span></code></pre></div></div>

<p>Two things to mention here:</p>

<ol>
  <li>
<code class="language-plaintext highlighter-rouge">Context.ask()</code> requires to be explicitly annotated with <code class="language-plaintext highlighter-rouge">_Deps</code>, because <code class="language-plaintext highlighter-rouge">mypy</code> cannot infer the type here</li>
  <li>
<code class="language-plaintext highlighter-rouge">.bind</code> method is also a composition utility. In contrast to <code class="language-plaintext highlighter-rouge">.map</code> which composes a container with a pure function, <code class="language-plaintext highlighter-rouge">.bind</code> allows us to compose a container with a function that also returns a container of the same type</li>
</ol>

<p>Now we can share the same immutable read-only context for all our code.</p>


    
      <h2 id="static-typing">
        
        <a class="anchor" href="#static-typing">Static typing</a>
        
      </h2>

<p>Static typing is much more than accidentally trying to add a string to an integer. It is about your architecture and rules that each piece of this complex system has.</p>

<p>And many readers might already found one trap that I have left in this example. Let’s reveal the ugly truth: <code class="language-plaintext highlighter-rouge">_maybe_add_extra_holiday_point</code> is not pure. We won’t be able to test it without a mock on <code class="language-plaintext highlighter-rouge">random</code>. And because it is impure, its type is <code class="language-plaintext highlighter-rouge">Callable[[int], IO[int]]</code>.</p>

<p>Wait, what is it? <a href="https://returns.readthedocs.io/en/latest/pages/io.html"><code class="language-plaintext highlighter-rouge">IO</code></a> is your best friend when we talk about good architecture and high-quality composition rules. It is an explicit marker that your function is not pure. Without this type, we are free to write an ugly, untestable code where we want it. We don’t have any contracts to respect. We can just pray for the reigning chaos.</p>

<p>And also, don’t forget that some functions may end up with successful execution and may also fail. <a href="https://sobolevn.me/2019/02/python-exceptions-considered-an-antipattern">Throwing exceptions</a> inside your business logic is ugly. And it also removes the explicit contract from your architecture. That’s a barbarian practice. If something can go wrong, we have to be prepared for it. That’s why many people use <a href="https://returns.readthedocs.io/en/latest/pages/result.html"><code class="language-plaintext highlighter-rouge">Result</code></a> to indicate that things can (and will!) go wrong.</p>

<p>All these two types are heavily related to our <code class="language-plaintext highlighter-rouge">RequiresContext</code> container. Because its return type can be tricky:</p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">RequiresContext[EnvType, ReturnType]</code> indicates that we work with a pure function that cannot fail (like in our example without <code class="language-plaintext highlighter-rouge">random</code>)</li>
  <li>
<code class="language-plaintext highlighter-rouge">RequiresContext[EnvType, Result[ValueType, ErrorType]]</code> indicates that we work with a pure function that can fail (for example when we use <code class="language-plaintext highlighter-rouge">/</code> math operator and <code class="language-plaintext highlighter-rouge">0</code> as a delimiter or any logical failures)</li>
  <li>
<code class="language-plaintext highlighter-rouge">RequiresContext[EnvType, IO[ReturnType]]</code> indicates that we work with an impure function that cannot fail (like our example with <code class="language-plaintext highlighter-rouge">random</code>)</li>
  <li>
<code class="language-plaintext highlighter-rouge">RequiresContext[EnvType, IO[Result[ValueType, ErrorType]]]</code> indicates that we work with an impure function that can fail (like HTTP, filesystem, or database calls)</li>
</ul>

<p>It does not look fun to compose, yeah? That’s why we also ship useful combinators with <a href="https://github.com/dry-python/returns"><code class="language-plaintext highlighter-rouge">returns</code></a> like:</p>

<ul>
  <li>
<a href="https://returns.readthedocs.io/en/latest/pages/context.html#requirescontextresult-container"><code class="language-plaintext highlighter-rouge">RequireContextResult</code></a> to easily work with <code class="language-plaintext highlighter-rouge">RequiresContext</code> which has <code class="language-plaintext highlighter-rouge">Result</code> as the return type</li>
  <li>
<a href="https://returns.readthedocs.io/en/latest/pages/context.html#requirescontextioresult-container"><code class="language-plaintext highlighter-rouge">RequiresContextIOResult</code></a> to easily work with <code class="language-plaintext highlighter-rouge">RequiresContext</code> which has <code class="language-plaintext highlighter-rouge">IO[Result]</code> as the return type</li>
</ul>

<p>This way <code class="language-plaintext highlighter-rouge">returns</code> library takes all the hacky composition rules on itself and provides nice API for our end users.</p>


    
      <h2 id="di-containers">
        
        <a class="anchor" href="#di-containers">DI containers</a>
        
      </h2>

<p>“So, are you saying that I should not use any DI frameworks at all?” one may ask after reading this article. And it is an interesting question indeed.</p>

<p>I have spent a lot of time thinking about this very topic myself. And my answer is: you can (and probably should) use a dependency injection container framework on the framework level.</p>

<p>And here’s why: in real-world apps your <code class="language-plaintext highlighter-rouge">_Deps</code> class with soon become really big. It would have lots of stuff inside:</p>

<ul>
  <li>Repositories and database-related utilities</li>
  <li>HTTP services and API integrations</li>
  <li>Permission and authentication helpers</li>
  <li>Caching layer</li>
  <li>Async tasks and utilities to work with them</li>
  <li>And probably more!</li>
</ul>

<p>To handle all this stuff you would need to import a lot of other stuff.
And you will need to create this monstrous object somehow. That’s where DI frameworks can help you. A lot.</p>

<p>With their magic creating this context might be a lot easier and safer. You need complex tools to fight real complexity.</p>

<p>That’s why tools like <a href="https://github.com/dry-python/dependencies"><code class="language-plaintext highlighter-rouge">dependencies</code></a> are required for every complex system: both functional and imperative.</p>


    
      <h2 id="conclusion">
        
        <a class="anchor" href="#conclusion">Conclusion</a>
        
      </h2>

<p>Let’s sum up things we have learned today:</p>

<ol>
  <li>Different applications require different levels of architecture and have different requirements on dependency injection</li>
  <li>If you are scared from magic DI containers have, use typed functional composition: <code class="language-plaintext highlighter-rouge">RequiresContext</code> can help you to provide the required context from the top level to the very bottom and to define nice composition API</li>
  <li>When writing high-level code think about your architecture and explicitly define your contracts as types. Use <code class="language-plaintext highlighter-rouge">IO</code> and <code class="language-plaintext highlighter-rouge">Result</code> to indicate possible failure and impurity</li>
  <li>Use composition helpers when in doubt</li>
  <li>Use DI containers on the very top level of your app, when complexity gets out of your control</li>
</ol>

<p>Functional programming is fun and easy! Feel free to <a href="https://github.com/dry-python/returns">star our repo</a> if you liked the concepts above. Or go to <a href="https://returns.readthedocs.io/en/latest/index.html">the docs</a> to learn more new things.</p>

<p>Very special thanks to <a href="https://www.facebook.com/nikolay.fominykh">Nikolay Fominykh</a> and <a href="https://github.com/supadrupa">Artem</a> for reviewing this article.</p>

    </div>

    <hr>

    <div class="post-subscribe">
      
<!-- Add following div tag where you want show soopr share buttons -->
<div class="soopr-btn"></div>

<!-- Just before body tag add this line -->
<script async defer data-soopr-token="pt_3c7922127f46ef4aa2b340d1b94b2025" src="https://sdk.soopr.co/soopr.js"></script>
  
    </div>

    
    
    <div class="post-republish">
      <h4>Republished as:</h4>
      <ul>
      
        <li>
          <a class="c-article__repost" href="https://dev.to/wemake-services/typed-functional-dependency-injection-in-python-4e7b" target="_blank">
            
            dev.to <img class="emoji" title=":us:" alt=":us:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f1fa-1f1f8.png" height="20" width="20">
          </a>
        </li>
      
      </ul>
    </div>
    
  </div>

  <!-- Disqus comments view -->
  
</article>

  </div>
  <footer class="c-page__footer">
  <p>
    <i class="far fa-copyright"></i>
    <a href="https://sobolevn.me/about/">imrishi</a>
    2023,
    content licensed
    <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">
      CC BY-NC
    </a>,
    <a href="https://github.com/sobolevn/sobolevn.github.io" target="_blank">
      source code
    </a>
  </p>

  <p>
    <a href="mailto:r@rishi.im" alt="email">
      <i class="far fa-2x fa-envelope"></i>
    </a>
    <a href="https://github.com/sobolevn" alt="github">
      <i class="fab fa-2x fa-github"></i>
    </a>
    <a href="https://dev.to/sobolevn" alt="practicaldev">
      <i class="fab fa-2x fa-dev"></i>
    </a>
    <a href="https://medium.com/@sobolevn" alt="medium">
      <i class="fab fa-2x fa-medium"></i>
    </a>
    <a href="https://stackoverflow.com/users/4842742/sobolevn" alt="stackoverflow">
      <i class="fab fa-2x fa-stack-overflow"></i>
    </a>
  </p>
</footer>

</div>

    </main>

    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-66588818-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-66588818-1');
</script>

  </body>
</html>
