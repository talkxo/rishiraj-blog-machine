<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Favicon -->
  <link rel="apple-touch-icon" sizes="57x57" href="/assets/images/favicons/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/assets/images/favicons/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/assets/images/favicons/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/assets/images/favicons/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/assets/images/favicons/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/assets/images/favicons/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/assets/images/favicons/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/assets/images/favicons/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/images/favicons/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192"  href="/assets/images/favicons/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/assets/images/favicons/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/images/favicons/manifest.json">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/assets/images/favicons/ms-icon-144x144.png">
<meta name="theme-color" content="#ffffff">


  <!-- Meta information -->
  <title>Typeclasses in Python</title>
  <meta name="description"
        content="Today I am going to introduce a new concept for Python developers: typeclasses.It is a concept behind our new dry-python library called classes.">
  <link rel="canonical"
        href="http://localhost:4000/2021/06/typeclasses-in-python" />

  <!-- Open search scheme -->
  <link rel="search"
        type="application/opensearchdescription+xml"
        title="sobolevn.me"
        href="/opensearch.xml" />

  <!-- Feed -->
  <link rel="alternate" type="application/rss+xml" title="sobolevn's personal blog"
        href="/feed.xml" />

  <!-- Custom fonts -->
  <link href="https://fonts.googleapis.com/css?family=Merriweather:400,400i,900|Roboto+Mono:400,400i|Montserrat:400,800" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">

  <!-- Custom style -->
  <link rel="stylesheet" href="/css/main.css" />

  <!-- Global site tag (gtag.js) - Google Ads: 839642990 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=AW-839642990"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'AW-839642990');
  </script>
</head>


  <body>
    <main class="u-container">
      <div class="c-page">
  <header class="c-page__header">
  <h1><code>sobolevn's personal blog</code></h1>

  

  <nav role="navigation">
    <a href="/" role="menuitem">
      Blog
    </a>

    <span class="u-separate"></span>
    <a href="/talks/" role="menuitem">
      Talks
    </a>

    <span class="u-separate"></span>
    <a href="/activities/" role="menuitem">
      Activities
    </a>

    <span class="u-separate"></span>
    <a href="/about/" role="menuitem">
      About
    </a>

    <span class="u-separate"></span>
    <a href="/subscribe/" role="menuitem">
      Subscribe
    </a>
  </nav>
</header>

  <div class="c-page__main">
    <article class="c-article" itemscope="" itemtype="http://schema.org/BlogPosting">
  <header class="c-article__header">
    <h1 class="c-article__title" itemprop="name">Typeclasses in Python</h1>
    <p class="c-article__time">
      <small>
        <time datetime="2021-06-30T00:00:00+05:30" itemprop="datePublished">
          June 30, 2021
        </time>
      </small>
      <small><span class="reading-time" title="Estimated read time">
  
  
    24 mins
   read
</span>
</small>
      <small><a href="#discussion">Start a discussion</a></small>
      <small><a href="https://github.com/sobolevn/sobolevn.github.io/blob/master/_posts/2021-06-30-typeclasses-in-python.md">Edit this page</a></small>
    </p>
  </header>

  <!-- Post Tags -->
  <!-- <ul class="c-tags">
    
    <li class="c-tag">python</li>
    
  </ul> -->

  <!-- Content -->
  <div class="c-article__main">

    
      
      
    

    <div class="c-article__body" itemprop="articleBody">
      <p>Today I am going to introduce a new concept for Python developers: typeclasses.
It is a concept behind our new <code class="language-plaintext highlighter-rouge">dry-python</code> library called <a href="https://github.com/dry-python/classes/"><code class="language-plaintext highlighter-rouge">classes</code></a>.</p>

<p>I will tell you in advance, that it will look very familiar to what you already know and possibly even use. Moreover, we reuse a lot of existing code from Python’s standard library. So, you can call this approach “native” and “pythonic”. And it is still going to be interesting: I am showing examples in 4 different languages!</p>

<p>But, before discussing typeclasses themselves, let’s discuss what problem they do solve.</p>


      <h2 id="some-functions-must-behave-differently">
        
        <a class="anchor" href="#some-functions-must-behave-differently">Some functions must behave differently</a>
        
      </h2>

<p>Ok, this one is a familiar problem to all of the devs out there.
How can we write a function that will behave differently for different types?</p>

<p>Let’s create an example. We want to <code class="language-plaintext highlighter-rouge">greet</code> different types differently (yes, “hello world” examples, here we go).
We want to <code class="language-plaintext highlighter-rouge">greet</code>:</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">str</code> instances as <code class="language-plaintext highlighter-rouge">Hello, {string_content}!</code>
</li>
  <li>
<code class="language-plaintext highlighter-rouge">MyUser</code> instances as <code class="language-plaintext highlighter-rouge">Hello again, {username}</code>
</li>
</ul>

<p>Note, that <code class="language-plaintext highlighter-rouge">greet</code> as a simple example does not really make much “business” sense, but more complicated things like <code class="language-plaintext highlighter-rouge">to_json</code>, <code class="language-plaintext highlighter-rouge">from_json</code>, <code class="language-plaintext highlighter-rouge">to_sql</code>, <code class="language-plaintext highlighter-rouge">from_sql</code>, and <code class="language-plaintext highlighter-rouge">to_binary</code> do make a lot of sense and can be found in almost any project.
But, for the sake of implementation simplicity, I’m going to stick to our <code class="language-plaintext highlighter-rouge">greet</code> example.</p>

<p>The first approach that comes to our minds is to use <code class="language-plaintext highlighter-rouge">isinstance()</code> checks inside the function itself.
And it can work in some cases! The only requirement is that we <strong>must</strong> know all the types we will work with in advance.</p>

<p>Here’s how it would look like:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">MyUser</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">def</span> <span class="nf">greet</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">MyUser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">'Hello, "{0}"!'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">MyUser</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">'Hello again, {0}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">instance</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">raise</span> <span class="nb">NotImplementedError</span><span class="p">(</span>
        <span class="s">'Cannot greet "{0}" type'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">instance</span><span class="p">)),</span>
    <span class="p">)</span>
</code></pre></div></div>

<p>The main limitation is that we cannot extend this function for other type easily (we can use wrapper function, but I consiser this a redefinition).</p>

<p>But, in some cases - <code class="language-plaintext highlighter-rouge">isinstance</code> won’t be enough, because we need extendability. We need to support other types, which are unknown in advance.
Our users might need to <code class="language-plaintext highlighter-rouge">greet</code> their custom types.</p>

<p>And that’s the part where things begin to get interesting.</p>

<p>All programming languages address this problem differently.
Let’s start with Python’s traditional OOP approach.</p>


    
      <h2 id="oop-extendability-and-over-abstraction-problems">
        
        <a class="anchor" href="#oop-extendability-and-over-abstraction-problems">OOP extendability and over-abstraction problems</a>
        
      </h2>

<p>So, how does Python solve this problem?</p>

<p>We all know that Python has magic methods for some builtin functions like <code class="language-plaintext highlighter-rouge">len()</code> and <code class="language-plaintext highlighter-rouge">__len__</code>, it solves exactly the same problem.</p>

<p>Let’s say we want to greet a user:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">MyUser</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>

    <span class="k">def</span> <span class="nf">greet</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">'Hello again, {0}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
</code></pre></div></div>

<p>You can use this method directly or you can create a helper with <a href="https://www.python.org/dev/peps/pep-0544/"><code class="language-plaintext highlighter-rouge">typing.Protocol</code></a>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">typing_extensions</span> <span class="kn">import</span> <span class="n">Protocol</span>

<span class="k">class</span> <span class="nc">CanGreet</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">greet</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="s">"""
        It will match any object that has the ``greet`` method.

        Mypy will also check that ``greet`` must return ``str``.
        """</span>

<span class="k">def</span> <span class="nf">greet</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="n">CanGreet</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">instance</span><span class="p">.</span><span class="n">greet</span><span class="p">()</span>
</code></pre></div></div>

<p>And then we can use it:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="n">greet</span><span class="p">(</span><span class="n">MyUser</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'example'</span><span class="p">)))</span>
<span class="c1"># Hello again, example
</span></code></pre></div></div>

<p>So, it works? <em>Not really</em>.</p>

<p>There are several problems.</p>

<p><strong>First</strong>, some classes do not want to know some details about themselves to maintain abstraction integrity.
For example:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Person</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">become_friends</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">friend</span><span class="p">:</span> <span class="s">'Person'</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
         <span class="p">...</span>

    <span class="k">def</span> <span class="nf">is_friend_of</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">person</span><span class="p">:</span> <span class="s">'Person'</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="p">...</span>

    <span class="k">def</span> <span class="nf">get_pets</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="s">'Pet'</span><span class="p">]:</span>
        <span class="p">...</span>
</code></pre></div></div>

<p>Does this <code class="language-plaintext highlighter-rouge">Person</code> (pun intended) deserve to know that some <code class="language-plaintext highlighter-rouge">to_json</code> conversion exists that can turn this poor <code class="language-plaintext highlighter-rouge">Person</code> into textual data? What about binary pickling?
Of course not, these details should not be added to a business-level abstraction, this is called a <a href="https://en.wikipedia.org/wiki/Leaky_abstraction">leaky abstraction</a> when you do otherwise.</p>

<p>Moreover, I think that mixing structure and behavior into a single abstraction is bad. Why? Because you cannot tell in advance what behavior you would need from a given structure.</p>

<p>For abstractions on this level, it is way easier to have behavior near the structure, not inside it. Mixing these two only makes sense when we work on a higher level like <a href="https://en.wikipedia.org/wiki/Service-oriented_architecture">services</a> or <a href="https://en.wikipedia.org/wiki/Open_Telecom_Platform">processes</a>.</p>

<p><strong>Second</strong>, it only works for custom types. <a href="https://en.wikipedia.org/wiki/Expression_problem">Existing types are hard to extend</a>.
For example, how would you add the <code class="language-plaintext highlighter-rouge">greet</code> method to the <code class="language-plaintext highlighter-rouge">str</code> type?</p>

<p>You can create <code class="language-plaintext highlighter-rouge">str</code> subtype with <code class="language-plaintext highlighter-rouge">greet</code> method in it:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MyStr</span><span class="p">(</span><span class="nb">str</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">greet</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">'Hello, {0}!'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre></div></div>

<p>But, this would require a change in our usage:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="n">greet</span><span class="p">(</span><span class="n">MyStr</span><span class="p">(</span><span class="s">'world'</span><span class="p">)))</span>
<span class="c1"># Hello, world!
</span>
<span class="k">print</span><span class="p">(</span><span class="n">greet</span><span class="p">(</span><span class="s">'world'</span><span class="p">))</span>
<span class="c1"># fails with TypeError
</span></code></pre></div></div>


    
      <h3 id="monkey-patching">
        
        <a class="anchor" href="#monkey-patching">Monkey-patching</a>
        
      </h3>

<p>Some might suggest that we can just insert the needed methods directly into an object / type.
Some dynamically typed languages went on this path: <code class="language-plaintext highlighter-rouge">JavaScript</code> (in 2000s and early 2010s, mostly popularized by <code class="language-plaintext highlighter-rouge">jQuery</code> plugins) and <code class="language-plaintext highlighter-rouge">Ruby</code> (<a href="https://guides.rubyonrails.org/active_support_core_extensions.html">still happening right now</a>). Here’s how it looks:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">String</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">greet</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">`Hello, </span><span class="p">${</span><span class="nx">string</span><span class="p">}</span><span class="s2">!`</span>
<span class="p">}</span>
</code></pre></div></div>

<p>It is quite obvious, that it is not going to work for anything complex. <a href="https://en.wikipedia.org/wiki/Monkey_patch#Pitfalls">Why</a>?</p>
<ul>
  <li>Different parts of your program might use monkey-patching of methods with the same name, but with different functionality. And nothing will work</li>
  <li>It is hard to read because the original source does not contain the patched method and the patching location might be hidden deeply in other files</li>
  <li>It is hard to type, for example, <code class="language-plaintext highlighter-rouge">mypy</code> does not support it at all</li>
  <li>Python community is not used to this style, it would be rather hard to persuade them to write their code like this (and that’s a good thing!)</li>
</ul>

<p>I hope that it is clear: we won’t fall into this trap. Let’s consider another alternative.</p>


    
      <h3 id="extra-abstractions">
        
        <a class="anchor" href="#extra-abstractions">Extra abstractions</a>
        
      </h3>

<p>People familiar with things like <code class="language-plaintext highlighter-rouge">django-rest-framework</code> might recommend to add <a href="https://www.django-rest-framework.org/api-guide/serializers/">special abstractions</a> to <code class="language-plaintext highlighter-rouge">greet</code> different types:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Generic</span><span class="p">,</span> <span class="n">TypeVar</span>

<span class="n">_Wrapped</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s">'_Wrapped'</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">BaseGreet</span><span class="p">(</span><span class="n">Generic</span><span class="p">[</span><span class="n">_Wrapped</span><span class="p">]):</span>
    <span class="s">"""Abstract class of all other """</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wrapped</span><span class="p">:</span> <span class="n">_Wrapped</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_wrapped</span> <span class="o">=</span> <span class="n">wrapped</span>

    <span class="o">@</span><span class="n">abc</span><span class="p">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">greet</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">NotImplementedError</span>

<span class="k">class</span> <span class="nc">StrGreet</span><span class="p">(</span><span class="n">BaseGreet</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
    <span class="s">"""Wrapped instance of built-in type ``str``."""</span>

    <span class="k">def</span> <span class="nf">greet</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">'Hello, {0}!'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">_wrapped</span><span class="p">)</span>

<span class="c1"># Our custom type:
</span>
<span class="o">@</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">MyUser</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">MyUserGreet</span><span class="p">(</span><span class="n">BaseGreet</span><span class="p">[</span><span class="n">MyUser</span><span class="p">]):</span>
    <span class="k">def</span> <span class="nf">greet</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">'Hello again, {0}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">_wrapped</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
</code></pre></div></div>

<p>And we can use it like so:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="n">greet</span><span class="p">(</span><span class="n">MyStrGreet</span><span class="p">(</span><span class="s">'world'</span><span class="p">)))</span>
<span class="c1"># Hello, world!
</span>
<span class="k">print</span><span class="p">(</span><span class="n">greet</span><span class="p">(</span><span class="n">MyUserGreet</span><span class="p">(</span><span class="n">MyUser</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'example'</span><span class="p">))))</span>
<span class="c1"># Hello again, example
</span></code></pre></div></div>

<p>But, now we have a different problem: we have a gap between real types and their wrappers. There’s no easy way to wrap a type into its wrapper. How can we match them? We have to do it either by hand or use some kind of registry like <code class="language-plaintext highlighter-rouge">Dict[type, Type[BaseGreet]]</code>.</p>

<p>And it is still not enough, there will be runtime errors! In practice, it ends up like <code class="language-plaintext highlighter-rouge">&lt;X&gt; is not json-serializable</code> as many of us might have seen it with <code class="language-plaintext highlighter-rouge">drf</code>’s serializers when trying to serialize a custom unregistered type.</p>


    
      <h2 id="typeclasses-and-similar-concepts">
        
        <a class="anchor" href="#typeclasses-and-similar-concepts">Typeclasses and similar concepts</a>
        
      </h2>

<p>Let’s look at how functional languages (and <code class="language-plaintext highlighter-rouge">Rust</code>, people still <a href="https://www.fpcomplete.com/blog/2018/10/is-rust-functional/">argue</a> whether it is functional or not) handle this problem.</p>

<p>Some common knowledge:</p>
<ul>
  <li>All these languages don’t have <code class="language-plaintext highlighter-rouge">class</code> concept as we know it in Python and, of course, there’s no subclassing</li>
  <li>All the languages below don’t have <code class="language-plaintext highlighter-rouge">object</code>s as we do in Python, they don’t mix behavior and structure (however, <code class="language-plaintext highlighter-rouge">Elixir</code> has Alan Kay’s <a href="https://www.quora.com/What-does-Alan-Kay-think-about-Joe-Armstrong-claiming-that-Erlang-might-be-the-only-object-oriented-language-and-also-his-thesis-supervisor-s-claim-that-Erlang-is-extremely-object-oriented">real objects</a>)</li>
  <li>Instead, these languages use <a href="https://en.wikipedia.org/wiki/Ad_hoc_polymorphism">ad-hoc polymorphism</a> to make functions behave differently for different types via overloading</li>
  <li>And, of course, you don’t have to know any of the languages below to understand what is going on</li>
</ul>


    
      <h3 id="elixir">
        
        <a class="anchor" href="#elixir">Elixir</a>
        
      </h3>

<p>Let’s start with one of my favorites.
<code class="language-plaintext highlighter-rouge">Elixir</code> has <a href="https://elixir-lang.org/getting-started/protocols.html"><code class="language-plaintext highlighter-rouge">Protocol</code>s</a> to achieve what we want:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">@doc</span> <span class="s2">"Our custom protocol"</span>
<span class="k">defprotocol</span> <span class="no">Greet</span> <span class="k">do</span>
  <span class="c1"># This is an abstract function,</span>
  <span class="c1"># that will behave differently for each type.</span>
  <span class="k">def</span> <span class="n">greet</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="k">end</span>

<span class="nv">@doc</span> <span class="s2">"Enhancing built-in type"</span>
<span class="k">defimpl</span> <span class="no">Greet</span><span class="p">,</span> <span class="ss">for:</span> <span class="no">BitString</span> <span class="k">do</span>
  <span class="k">def</span> <span class="n">greet</span><span class="p">(</span><span class="n">string</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="s2">"Hello, </span><span class="si">#{</span><span class="n">string</span><span class="si">}</span><span class="s2">!"</span>
<span class="k">end</span>

<span class="nv">@doc</span> <span class="s2">"Custom data type"</span>
<span class="k">defmodule</span> <span class="no">MyUser</span> <span class="k">do</span>
  <span class="k">defstruct</span> <span class="p">[</span><span class="ss">:name</span><span class="p">]</span>
<span class="k">end</span>

<span class="nv">@doc</span> <span class="s2">"Enhancing our own type"</span>
<span class="k">defimpl</span> <span class="no">Greet</span><span class="p">,</span> <span class="ss">for:</span> <span class="no">MyUser</span> <span class="k">do</span>
  <span class="k">def</span> <span class="n">greet</span><span class="p">(</span><span class="n">user</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="s2">"Hello again, </span><span class="si">#{</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>
</code></pre></div></div>

<p>I am pretty sure that my readers were able to read and understand <code class="language-plaintext highlighter-rouge">Elixir</code> even if they are not familiar with this language. That’s what I call beauty!</p>

<p>Usage of the code above:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Using our `Greet.greet` function with both our data types:</span>
<span class="no">IO</span><span class="o">.</span><span class="n">puts</span><span class="p">(</span><span class="no">Greet</span><span class="o">.</span><span class="n">greet</span><span class="p">(</span><span class="s2">"world"</span><span class="p">))</span>
<span class="c1"># Hello, world!</span>
<span class="no">IO</span><span class="o">.</span><span class="n">puts</span><span class="p">(</span><span class="no">Greet</span><span class="o">.</span><span class="n">greet</span><span class="p">(%</span><span class="no">MyUser</span><span class="p">{</span><span class="ss">name:</span> <span class="s2">"example"</span><span class="p">}))</span>
<span class="c1"># Hello again, example</span>
</code></pre></div></div>

<p>The thing with <code class="language-plaintext highlighter-rouge">Elixir</code>’s <code class="language-plaintext highlighter-rouge">Protocol</code>s is that it is <a href="https://github.com/elixir-lang/elixir/issues/7541">not currently possible</a> to express that some type does support our <code class="language-plaintext highlighter-rouge">Greet.greet</code> for <code class="language-plaintext highlighter-rouge">Elixir</code>’s <a href="https://github.com/jeremyjh/dialyxir">type checker</a>.
But, this is not a big deal for <code class="language-plaintext highlighter-rouge">Elixir</code>, which is 100% dynamically typed.</p>

<p>Protocols are very widely used, they power lots of the language’s features.
Here are some real-life examples:</p>
<ul>
  <li>
<a href="https://hexdocs.pm/elixir/1.11.0/Enumerable.html"><code class="language-plaintext highlighter-rouge">Enumerable</code></a> allows to work with collections: counting elements, finding members, reducing, and slicing</li>
  <li>
<a href="https://hexdocs.pm/elixir/1.11.0/String.Chars.html"><code class="language-plaintext highlighter-rouge">String.Chars</code></a> is something like <code class="language-plaintext highlighter-rouge">__str__</code> in Python, it converts structures to human-readable format</li>
</ul>


    
      <h3 id="rust">
        
        <a class="anchor" href="#rust">Rust</a>
        
      </h3>

<p><code class="language-plaintext highlighter-rouge">Rust</code> has <a href="https://doc.rust-lang.org/book/ch10-02-traits.html"><code class="language-plaintext highlighter-rouge">Trait</code>s</a>. The concept is pretty similar to <code class="language-plaintext highlighter-rouge">Protocol</code>s in <code class="language-plaintext highlighter-rouge">Elixir</code>:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// Our custom trait</span>
<span class="k">trait</span> <span class="n">Greet</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">greet</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">String</span><span class="p">;</span>
<span class="p">}</span>

<span class="c">// Enhancing built-in type</span>
<span class="k">impl</span> <span class="n">Greet</span> <span class="k">for</span> <span class="nb">String</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">greet</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">String</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nd">format!</span><span class="p">(</span><span class="s">"Hello, {}!"</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">self</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c">// Defining our own type</span>
<span class="k">struct</span> <span class="n">MyUser</span> <span class="p">{</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
<span class="p">}</span>

<span class="c">// Enhancing it</span>
<span class="k">impl</span> <span class="n">Greet</span> <span class="k">for</span> <span class="n">MyUser</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">greet</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">String</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nd">format!</span><span class="p">(</span><span class="s">"Hello again, {}"</span><span class="p">,</span> <span class="k">self</span><span class="py">.name</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And of course, due to <code class="language-plaintext highlighter-rouge">Rust</code>’s static typing, we can express that some function’s argument supports the trait we have just defined:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// We can express that `greet` function only accepts types</span>
<span class="c">// that implement `Greet` trait:</span>
<span class="k">fn</span> <span class="nf">greet</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">dyn</span> <span class="n">Greet</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">String</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">instance</span><span class="nf">.greet</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">pub</span> <span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c">// Using our `greet` function with both our data types:</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span> <span class="nf">greet</span><span class="p">(</span><span class="o">&amp;</span><span class="s">"world"</span><span class="nf">.to_string</span><span class="p">()));</span>
    <span class="c">// Hello, world!</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span> <span class="nf">greet</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MyUser</span> <span class="p">{</span> <span class="n">name</span><span class="p">:</span> <span class="s">"example"</span><span class="nf">.to_string</span><span class="p">()</span> <span class="p">}));</span>
    <span class="c">// Hello again, example</span>
<span class="p">}</span>
</code></pre></div></div>

<p>See? The idea is so similar, that it uses almost the same syntax as <code class="language-plaintext highlighter-rouge">Elixir</code>.</p>

<p>Notable real-life examples of how <code class="language-plaintext highlighter-rouge">Rust</code> uses its <code class="language-plaintext highlighter-rouge">Trait</code>s:</p>
<ul>
  <li>
<a href="https://doc.rust-lang.org/std/marker/trait.Copy.html"><code class="language-plaintext highlighter-rouge">Copy</code></a> and <a href="https://doc.rust-lang.org/std/clone/trait.Clone.html"><code class="language-plaintext highlighter-rouge">Clone</code></a> - duplicating objects</li>
  <li>
<a href="https://doc.rust-lang.org/std/fmt/trait.Debug.html"><code class="language-plaintext highlighter-rouge">Debug</code></a> to show better <code class="language-plaintext highlighter-rouge">repr</code> of an object, again like <code class="language-plaintext highlighter-rouge">__str__</code> in Python</li>
</ul>

<p>Basically, <code class="language-plaintext highlighter-rouge">Trait</code>s are the core of this language, it is widely used in cases when you need to define any shared behavior.</p>


    
      <h3 id="haskell">
        
        <a class="anchor" href="#haskell">Haskell</a>
        
      </h3>

<p><code class="language-plaintext highlighter-rouge">Haskell</code> has <a href="http://learnyouahaskell.com/making-our-own-types-and-typeclasses">typeclasses</a> to do almost the same thing.</p>

<p>So, what’s a typeclass?
Typeclass is a group of types, all of which satisfy some common contract.
It is also a form of ad-hoc polymorphism that is mostly used for overloading.</p>

<p>I am a bit sorry for the <code class="language-plaintext highlighter-rouge">Haskell</code> syntax below, it might be not very pleasant and clear to read, especially for people who are not familiar with this brilliant language, but we have what we have:</p>

<div class="language-haskell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">{-# LANGUAGE FlexibleInstances #-}</span>

<span class="c1">-- Our custom typeclass</span>
<span class="kr">class</span> <span class="kt">Greet</span> <span class="kr">instance</span> <span class="kr">where</span>
  <span class="n">greet</span> <span class="o">::</span> <span class="kr">instance</span> <span class="o">-&gt;</span> <span class="kt">String</span>

<span class="c1">-- Enhancing built-in type with it</span>
<span class="kr">instance</span> <span class="kt">Greet</span> <span class="kt">String</span> <span class="kr">where</span>
  <span class="n">greet</span> <span class="n">str</span> <span class="o">=</span> <span class="s">"Hello, "</span> <span class="o">++</span> <span class="n">str</span> <span class="o">++</span> <span class="s">"!"</span>

<span class="c1">-- Defining our own type</span>
<span class="kr">data</span> <span class="kt">MyUser</span> <span class="o">=</span> <span class="kt">MyUser</span> <span class="p">{</span> <span class="n">name</span> <span class="o">::</span> <span class="kt">String</span> <span class="p">}</span>

<span class="c1">-- Enhancing it</span>
<span class="kr">instance</span> <span class="kt">Greet</span> <span class="kt">MyUser</span> <span class="kr">where</span>
  <span class="n">greet</span> <span class="n">user</span> <span class="o">=</span> <span class="s">"Hello again, "</span> <span class="o">++</span> <span class="p">(</span><span class="n">name</span> <span class="n">user</span><span class="p">)</span>
</code></pre></div></div>

<p>Basically, we do the same thing as we have already done for <code class="language-plaintext highlighter-rouge">Rust</code> and <code class="language-plaintext highlighter-rouge">Elixir</code>:</p>
<ol>
  <li>We define a <code class="language-plaintext highlighter-rouge">Greet</code> typeclass that has a single function to implement: <code class="language-plaintext highlighter-rouge">greet</code>
</li>
  <li>Then we define instance implementation for <code class="language-plaintext highlighter-rouge">String</code> type, which is a built-in (alias for <code class="language-plaintext highlighter-rouge">[Char]</code>)</li>
  <li>Then we define custom <code class="language-plaintext highlighter-rouge">MyUser</code> type with <code class="language-plaintext highlighter-rouge">name</code> field of <code class="language-plaintext highlighter-rouge">String</code> type</li>
  <li>Implementing the <code class="language-plaintext highlighter-rouge">Greet</code> typeclass for <code class="language-plaintext highlighter-rouge">MyUser</code> is the last thing we do</li>
</ol>

<p>Then we can use our new <code class="language-plaintext highlighter-rouge">greet</code> function:</p>

<div class="language-haskell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Here you can see that we can use `Greet` typeclass to annotate our types.</span>
<span class="c1">-- I have made this alias entirely for this annotation demo,</span>
<span class="c1">-- in real life we would just use `greet` directly:</span>
<span class="n">greetAlias</span> <span class="o">::</span> <span class="kt">Greet</span> <span class="kr">instance</span> <span class="o">=&gt;</span> <span class="kr">instance</span> <span class="o">-&gt;</span> <span class="kt">String</span>
<span class="n">greetAlias</span> <span class="o">=</span> <span class="n">greet</span>

<span class="n">main</span> <span class="o">=</span> <span class="kr">do</span>
  <span class="n">print</span> <span class="o">$</span> <span class="n">greetAlias</span> <span class="s">"world"</span>
  <span class="c1">-- Hello, world!</span>
  <span class="n">print</span> <span class="o">$</span> <span class="n">greetAlias</span> <span class="kt">MyUser</span> <span class="p">{</span> <span class="n">name</span><span class="o">=</span><span class="s">"example"</span> <span class="p">}</span>
  <span class="c1">-- Hello again, example</span>
</code></pre></div></div>

<p>Some real-life examples of typeclasses:</p>
<ul>
  <li>
<a href="https://hackage.haskell.org/package/base-4.15.0.0/docs/Text-Show.html#t:Show"><code class="language-plaintext highlighter-rouge">Show</code></a> to convert things into user-readable representations</li>
  <li>
<a href="https://wiki.haskell.org/Functor"><code class="language-plaintext highlighter-rouge">Functor</code></a>, <a href="https://hackage.haskell.org/package/base-4.10.1.0/docs/Control-Applicative.html#t:Applicative"><code class="language-plaintext highlighter-rouge">Applicate</code></a>, and <a href="https://wiki.haskell.org/Monad"><code class="language-plaintext highlighter-rouge">Monad</code></a> are all typeclasses</li>
</ul>

<p>I would say that among our three examples, <code class="language-plaintext highlighter-rouge">Haskell</code> relies on its typeclasses the heaviest.</p>

<p>It is important to note that typeclasses from <code class="language-plaintext highlighter-rouge">Haskell</code> and traits from <code class="language-plaintext highlighter-rouge">Rust</code> <a href="https://stackoverflow.com/questions/28123453/what-is-the-difference-between-traits-in-rust-and-typeclasses-in-haskell">are a bit different</a>, but we won’t go into these details to keep this article rather short.</p>

<p>But, what about Python?</p>


    
      <h2 id="dry-pythonclasses">
        
        <a class="anchor" href="#dry-pythonclasses">dry-python/classes</a>
        
      </h2>

<p>There’s an awesome function in the Python standard library called <a href="https://docs.python.org/3/library/functools.html#functools.singledispatch"><code class="language-plaintext highlighter-rouge">singledispatch</code></a>.</p>

<p>It does exactly what we need. Do you still remember that we are finding a way to change the function’s behavior based on the input type?</p>

<p>Let’s have a look!</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">singledispatch</span>

<span class="o">@</span><span class="n">singledispatch</span>
<span class="k">def</span> <span class="nf">greet</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="s">"""Default case."""</span>
    <span class="k">raise</span> <span class="nb">NotImplementedError</span>

<span class="o">@</span><span class="n">greet</span><span class="p">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">_greet_str</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="s">'Hello, {0}!'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>

<span class="c1"># Custom type
</span>
<span class="o">@</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">MyUser</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>

<span class="o">@</span><span class="n">greet</span><span class="p">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">_greet_myuser</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="n">MyUser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="s">'Hello again, {0}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">instance</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
</code></pre></div></div>

<p>Looks cool, moreover, it is in standard lib, you even don’t have to install anything!</p>

<p>And we can use it like a normal function:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="n">greet</span><span class="p">(</span><span class="s">'world'</span><span class="p">))</span>
<span class="c1"># Hello, world!
</span><span class="k">print</span><span class="p">(</span><span class="n">greet</span><span class="p">(</span><span class="n">MyUser</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'example'</span><span class="p">)))</span>
<span class="c1"># Hello again, example
</span></code></pre></div></div>

<p>So, what’s the point in writing a completely different library like we did with <code class="language-plaintext highlighter-rouge">dry-python/classes</code>?</p>

<p>We even reuse some parts of <code class="language-plaintext highlighter-rouge">singledispatch</code> implementation,
but there are several key differences.</p>


    
      <h3 id="better-typing">
        
        <a class="anchor" href="#better-typing">Better typing</a>
        
      </h3>

<p>With <code class="language-plaintext highlighter-rouge">singledispatch</code> you cannot be sure that everything will work, because it is not supported by <code class="language-plaintext highlighter-rouge">mypy</code>.</p>

<p>For example, you can pass unsupported types:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">greet</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># mypy is ok with that :(
# runtime will raise `NotImplementedError`
</span></code></pre></div></div>

<p>In <code class="language-plaintext highlighter-rouge">dry-python/classes</code> we have fixed that.
You can only pass types that are supported:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">classes</span> <span class="kn">import</span> <span class="n">typeclass</span>

<span class="o">@</span><span class="n">typeclass</span>
<span class="k">def</span> <span class="nf">greet</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="p">...</span>

<span class="o">@</span><span class="n">greet</span><span class="p">.</span><span class="n">instance</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_greet_str</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="s">'Iterable!'</span>

<span class="n">greet</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># Argument 1 to "greet" has incompatible type "int"; expected "str"
</span></code></pre></div></div>

<p>Or you can break the <code class="language-plaintext highlighter-rouge">@singledispatch</code> signature contract:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">greet</span><span class="p">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">_greet_dict</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">instance</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>  <span class="c1"># still no mypy error
</span></code></pre></div></div>

<p>But, not with <code class="language-plaintext highlighter-rouge">dry-python/classes</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">greet</span><span class="p">.</span><span class="n">instance</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_greet_dict</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="p">...</span>
<span class="c1"># Instance callback is incompatible
# "def (instance: builtins.dict[Any, Any], key: builtins.str) -&gt; builtins.int";
# expected
# "def (instance: builtins.dict[Any, Any]) -&gt; builtins.str"
</span></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">@singledispatch</code> also does not allow defining generic functions:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">singledispatch</span>
<span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="n">X</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">X</span><span class="p">:</span>
    <span class="s">"""Default case."""</span>
    <span class="k">raise</span> <span class="nb">NotImplementedError</span>

<span class="o">@</span><span class="n">copy</span><span class="p">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">_copy_int</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">instance</span>
<span class="c1"># Argument 1 to "register" of "_SingleDispatchCallable"
# has incompatible type "Callable[[int], int]";
# expected "Callable[..., X]"
</span>
<span class="n">reveal_type</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="c1"># Revealed type is "X`-1"
# Should be: `int`
</span></code></pre></div></div>

<p>Which is, again, possible with <code class="language-plaintext highlighter-rouge">dry-python/classes</code>, we fully support <a href="https://classes.readthedocs.io/en/latest/pages/generics.html">generic functions</a>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TypeVar</span>
<span class="kn">from</span> <span class="nn">classes</span> <span class="kn">import</span> <span class="n">typeclass</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s">'X'</span><span class="p">)</span>

<span class="o">@</span><span class="n">typeclass</span>
<span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="n">X</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">X</span><span class="p">:</span>
    <span class="p">...</span>

<span class="o">@</span><span class="n">copy</span><span class="p">.</span><span class="n">instance</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_copy_int</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="p">...</span>  <span class="c1"># ok
</span>
<span class="n">reveal_type</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>  <span class="c1"># int
</span></code></pre></div></div>

<p>And you cannot <a href="https://classes.readthedocs.io/en/latest/pages/concept.html#type-restrictions">restrict</a> <code class="language-plaintext highlighter-rouge">@singledispatch</code> to work with only subtypes of specific types, even if you want to.</p>


    
      <h3 id="protocols-are-unsupported">
        
        <a class="anchor" href="#protocols-are-unsupported">Protocols are unsupported</a>
        
      </h3>

<p>Protocols are an important part of Python. Sadly, they are not supported by <code class="language-plaintext highlighter-rouge">@singledispatch</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">greet</span><span class="p">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">_greet_iterable</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="s">'Iterable!'</span>
<span class="c1"># TypeError: Invalid annotation for 'instance'.
# typing.Iterable is not a class
</span></code></pre></div></div>

<p><a href="https://classes.readthedocs.io/en/latest/pages/concept.html#protocols">Protocols</a> support is also solved with <code class="language-plaintext highlighter-rouge">dry-python/classes</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterable</span>
<span class="kn">from</span> <span class="nn">classes</span> <span class="kn">import</span> <span class="n">typeclass</span>

<span class="o">@</span><span class="n">typeclass</span>
<span class="k">def</span> <span class="nf">greet</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="p">...</span>

<span class="o">@</span><span class="n">greet</span><span class="p">.</span><span class="n">instance</span><span class="p">(</span><span class="n">Iterable</span><span class="p">,</span> <span class="n">is_protocol</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_greet_str</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="s">'Iterable!'</span>

<span class="k">print</span><span class="p">(</span><span class="n">greet</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]))</span>
<span class="c1"># Iterable!
</span></code></pre></div></div>


    
      <h3 id="no-way-to-annotate-types">
        
        <a class="anchor" href="#no-way-to-annotate-types">No way to annotate types</a>
        
      </h3>

<p>Let’s say you want to write a function and annotate one of its arguments that it must support the <code class="language-plaintext highlighter-rouge">greet</code> function. Something like:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">greet_and_print</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="s">'???'</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">greet</span><span class="p">(</span><span class="n">instance</span><span class="p">))</span>
</code></pre></div></div>

<p>It is impossible with <code class="language-plaintext highlighter-rouge">@singledispatch</code>.
But, you can do it with <code class="language-plaintext highlighter-rouge">dry-python/classes</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">classes</span> <span class="kn">import</span> <span class="n">AssociatedType</span><span class="p">,</span> <span class="n">Supports</span><span class="p">,</span> <span class="n">typeclass</span>

<span class="k">class</span> <span class="nc">Greet</span><span class="p">(</span><span class="n">AssociatedType</span><span class="p">):</span>
    <span class="s">"""Special type to represent that some instance can `greet`."""</span>

<span class="o">@</span><span class="n">typeclass</span><span class="p">(</span><span class="n">Greet</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">greet</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="s">"""No implementation needed."""</span>

<span class="o">@</span><span class="n">greet</span><span class="p">.</span><span class="n">instance</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_greet_str</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="s">'Hello, {0}!'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">greet_and_print</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="n">Supports</span><span class="p">[</span><span class="n">Greet</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">greet</span><span class="p">(</span><span class="n">instance</span><span class="p">))</span>

<span class="n">greet_and_print</span><span class="p">(</span><span class="s">'world'</span><span class="p">)</span>  <span class="c1"># ok
</span><span class="n">greet_and_print</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># type error with mypy, exception in runtime
# Argument 1 to "greet_and_print" has incompatible type "int";
# expected "Supports[Greet]"
</span></code></pre></div></div>


    
      <h2 id="conclusion">
        
        <a class="anchor" href="#conclusion">Conclusion</a>
        
      </h2>

<p>We have come a long way, from basic stacked <code class="language-plaintext highlighter-rouge">isinstance()</code> conditions - through OOP - to typeclasses.</p>

<p>I have shown, that this native and pythonic idea deserves wider recognition and usage. And our extra features in <code class="language-plaintext highlighter-rouge">dry-python/classes</code> can save you from lots of mistakes and help to write more expressive and safe business logic.</p>

<p>As a result of using typeclasses, you will untangle your structures from behavior, which will allow you to get rid of useless and complex abstractions and write dead-simple typesafe code. You will have your behavior near the structures, not inside them. This will also solve the extendability problem of OOP.</p>

<p>Combine it with other <code class="language-plaintext highlighter-rouge">dry-python</code> libraries for extra effect!</p>


    
      <h2 id="future-work">
        
        <a class="anchor" href="#future-work">Future work</a>
        
      </h2>

<p>What do we plan for the future?</p>

<p>There are several key aspects to improve:</p>
<ol>
  <li>Our <code class="language-plaintext highlighter-rouge">Supports</code> should take any amount of type arguments: <code class="language-plaintext highlighter-rouge">Supports[A, B, C]</code>. This type will represent a type that supports all three typeclasses <code class="language-plaintext highlighter-rouge">A</code>, <code class="language-plaintext highlighter-rouge">B</code>, and <code class="language-plaintext highlighter-rouge">C</code> <a href="https://github.com/dry-python/classes/issues/206">at the same time</a>
</li>
  <li>We don’t <a href="https://github.com/dry-python/classes/issues/24">support concrete generics</a> just yet. So, for example, it is impossible to define different cases for <code class="language-plaintext highlighter-rouge">List[int]</code> and <code class="language-plaintext highlighter-rouge">List[str]</code>. This might require adding runtime typecheker to <code class="language-plaintext highlighter-rouge">dry-python/classes</code>
</li>
  <li>I am planning <a href="https://sobolevn.me/2021/02/make-tests-a-part-of-your-app">to make tests a part of this app</a> as well! We will ship a <a href="https://github.com/dry-python/classes/issues/234">hypothesis plugin</a> to test users’ typeclasses in a single line of code</li>
</ol>

<p>Stay tuned!</p>

<p>If you like this article you can:</p>
<ol>
  <li>Donate to future <code class="language-plaintext highlighter-rouge">dry-python</code> development on <a href="https://github.com/sponsors/dry-python">GitHub</a>
</li>
  <li><a href="https://github.com/dry-python/classes/stargazers">Star our <code class="language-plaintext highlighter-rouge">classes</code> repo</a></li>
  <li>
<a href="https://sobolevn.me/subscribe/">Subscribe</a> to my blog for more content!</li>
</ol>

    </div>

    <hr>

    <div class="post-subscribe">
      <h2>
        <a href="https://sobolevn.me/subscribe">
          Subscribe to my blog if you want more
        </a>
      </h2>
    </div>

    
    
    <div class="post-republish">
      <h4>Republished as:</h4>
      <ul>
      
        <li>
          <a class="c-article__repost" href="https://dev.to/wemake-services/typeclasses-in-python-3ma6" target="_blank">
            
            dev.to <img class="emoji" title=":us:" alt=":us:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f1fa-1f1f8.png" height="20" width="20">
          </a>
        </li>
      
      </ul>
    </div>
    
  </div>

  <!-- Disqus comments view -->
  
  <div class="post-disqus" id="discussion">
    <div id="disqus_thread"></div>

<script>
/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/

var disqus_config = function () {
this.page.url = "http://localhost:4000/2021/06/typeclasses-in-python";
this.page.identifier = "/2021/06/typeclasses-in-python";
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://sobolevn-me.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>

  </div>
  
</article>

  </div>
  <footer class="c-page__footer">
  <p>
    <i class="far fa-copyright"></i>
    <a href="https://sobolevn.me/about/">sobolevn</a>
    2023,
    content licensed
    <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">
      CC BY-NC
    </a>,
    <a href="https://github.com/sobolevn/sobolevn.github.io" target="_blank">
      source code
    </a>
  </p>

  <p>
    <a href="mailto:mail@sobolevn.me" alt="email">
      <i class="far fa-2x fa-envelope"></i>
    </a>
    <a href="https://github.com/sobolevn" alt="github">
      <i class="fab fa-2x fa-github"></i>
    </a>
    <a href="https://dev.to/sobolevn" alt="practicaldev">
      <i class="fab fa-2x fa-dev"></i>
    </a>
    <a href="https://medium.com/@sobolevn" alt="medium">
      <i class="fab fa-2x fa-medium"></i>
    </a>
    <a href="https://stackoverflow.com/users/4842742/sobolevn" alt="stackoverflow">
      <i class="fab fa-2x fa-stack-overflow"></i>
    </a>
  </p>
</footer>

</div>

    </main>

    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-66588818-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-66588818-1');
</script>

  </body>
</html>
