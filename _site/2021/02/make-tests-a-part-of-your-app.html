<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Favicon -->
  <link rel="apple-touch-icon" sizes="57x57" href="/assets/images/favicons/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/assets/images/favicons/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/assets/images/favicons/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/assets/images/favicons/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/assets/images/favicons/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/assets/images/favicons/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/assets/images/favicons/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/assets/images/favicons/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/images/favicons/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192"  href="/assets/images/favicons/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/assets/images/favicons/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/images/favicons/manifest.json">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/assets/images/favicons/ms-icon-144x144.png">
<meta name="theme-color" content="#ffffff">


  <!-- Meta information -->
  <title>Make tests a part of your app</title>
  <meta name="description"
        content="">
  <link rel="canonical"
        href="http://localhost:4000/2021/02/make-tests-a-part-of-your-app" />

  <!-- Open search scheme -->
  <link rel="search"
        type="application/opensearchdescription+xml"
        title="sobolevn.me"
        href="/opensearch.xml" />

  <!-- Feed -->
  <link rel="alternate" type="application/rss+xml" title="sobolevn's personal blog"
        href="/feed.xml" />

  <!-- Custom fonts -->
  <link href="https://fonts.googleapis.com/css?family=Merriweather:400,400i,900|Roboto+Mono:400,400i|Montserrat:400,800" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">

  <!-- Custom style -->
  <link rel="stylesheet" href="/css/main.css" />

  <!-- Global site tag (gtag.js) - Google Ads: 839642990 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=AW-839642990"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'AW-839642990');
  </script>
</head>


  <body>
    <main class="u-container">
      <div class="c-page">
  <header class="c-page__header">
  <h1><code>sobolevn's personal blog</code></h1>

  

  <nav role="navigation">
    <a href="/" role="menuitem">
      Blog
    </a>

    <span class="u-separate"></span>
    <a href="/talks/" role="menuitem">
      Talks
    </a>

    <span class="u-separate"></span>
    <a href="/activities/" role="menuitem">
      Activities
    </a>

    <span class="u-separate"></span>
    <a href="/about/" role="menuitem">
      About
    </a>

    <span class="u-separate"></span>
    <a href="/subscribe/" role="menuitem">
      Subscribe
    </a>
  </nav>
</header>

  <div class="c-page__main">
    <article class="c-article" itemscope="" itemtype="http://schema.org/BlogPosting">
  <header class="c-article__header">
    <h1 class="c-article__title" itemprop="name">Make tests a part of your app</h1>
    <p class="c-article__time">
      <small>
        <time datetime="2021-02-28T00:00:00+05:30" itemprop="datePublished">
          February 28, 2021
        </time>
      </small>
      <small><span class="reading-time" title="Estimated read time">
  
  
    16 mins
   read
</span>
</small>
      <small><a href="#discussion">Start a discussion</a></small>
      <small><a href="https://github.com/sobolevn/sobolevn.github.io/blob/master/_posts/2021-02-28-make-tests-a-part-of-your-app.md">Edit this page</a></small>
    </p>
  </header>

  <!-- Post Tags -->
  <!-- <ul class="c-tags">
    
    <li class="c-tag">python</li>
    
  </ul> -->

  <!-- Content -->
  <div class="c-article__main">

    
      
      
      <div class="post-translate">
        <h4>Translated to:</h4>
        <ul>
        
          <li>
            <a class="c-article__repost" href="https://habr.com/ru/post/545646/" target="_blank">
              Russian <img class="emoji" title=":ru:" alt=":ru:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f1f7-1f1fa.png" height="20" width="20">
            </a>
            
          </li>
        
        </ul>
      </div>
      
    

    <div class="c-article__body" itemprop="articleBody">
      <p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/c4y2pgr3ddjtu33svrm2.png" alt="Cover image"></p>

<p>Today I am going to discuss quite a new idea for Python users, an idea of making tests a valuable part of your application.</p>

<p>Let’s jump into it.</p>


      <h2 id="current-status">
        
        <a class="anchor" href="#current-status">Current status</a>
        
      </h2>

<p>Right now the status-quo for source code/tests dualism is that you ship source code to your library users and most often do not include your tests in any manner.</p>

<p>Sometimes people also attach the <code class="language-plaintext highlighter-rouge">tests/</code> folder to a release, so they are just laying around just in case. Most of the time they are useless to the end-user.</p>

<p>And what is the most important part of it all is that our users are often find themselves in a situation when they have to reimplement some tests for library-specific things.</p>

<p>Let me give you an example: you have a Django view for authorized users only.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.contrib.auth.decorators</span> <span class="kn">import</span> <span class="n">login_required</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpRequest</span><span class="p">,</span> <span class="n">HttpResponse</span>

<span class="o">@</span><span class="n">login_required</span>
<span class="k">def</span> <span class="nf">my_view</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpRespose</span><span class="p">:</span>
    <span class="p">...</span>
</code></pre></div></div>

<p>So, in our tests we would have to write at least two tests:</p>
<ol>
  <li>For the successful auth case and our business logic</li>
  <li>For the failed auth case</li>
</ol>

<p>Wouldn’t it be amazing if we could just skip the second one and rely on some existing test-logic that we can re-use from the library itself?</p>

<p>Imagine an API like:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># tests/test_views/test_my_view.py
</span><span class="kn">from</span> <span class="nn">myapp.views</span> <span class="kn">import</span> <span class="n">my_view</span>

<span class="k">def</span> <span class="nf">test_authed_successfully</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
    <span class="s">"""Test case for our own logic."""</span>

<span class="c1"># Not authed case:
</span><span class="n">my_view</span><span class="p">.</span><span class="n">test_not_authed</span><span class="p">()</span>
</code></pre></div></div>

<p>And then - boom - we have our second use-case tested with just a single line of code!</p>

<p>And it goes further than this. For example, in Django you can stack function <a href="https://docs.djangoproject.com/en/3.1/topics/http/decorators/">decorators</a> to do multiple things. Imagine this situation:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.views.decorators.cache</span> <span class="kn">import</span> <span class="n">never_cache</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.decorators</span> <span class="kn">import</span> <span class="n">login_required</span>
<span class="kn">from</span> <span class="nn">django.views.decorators.http</span> <span class="kn">import</span> <span class="n">require_http_methods</span>

<span class="o">@</span><span class="n">require_http_methods</span><span class="p">([</span><span class="s">'GET'</span><span class="p">,</span> <span class="s">'POST'</span><span class="p">])</span>
<span class="o">@</span><span class="n">login_required</span>
<span class="o">@</span><span class="n">never_cache</span>
<span class="k">def</span> <span class="nf">my_view</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpRespose</span><span class="p">:</span>
    <span class="p">...</span>
</code></pre></div></div>

<p>So, the API might be a little more magical to include a test for all the possible cases:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># tests/test_views/test_my_view.py
</span><span class="kn">from</span> <span class="nn">myapp.views</span> <span class="kn">import</span> <span class="n">my_view</span>

<span class="n">my_view</span><span class="p">.</span><span class="n">run_tests</span><span class="p">()</span>
</code></pre></div></div>

<p>And it can potentially execute:</p>
<ol>
  <li>Tests for http methods that are not allowed</li>
  <li>Tests for http methods that are allowed</li>
  <li>Test that <code class="language-plaintext highlighter-rouge">Cache-Control</code> header is there and has a correct value</li>
  <li>Test that unauthorized users are not allowed</li>
  <li>And possibly others!</li>
</ol>

<p>All you have to do is testing your green path with a possibility to customize some particular generated test cases if you have some specifics, like returning a custom http code for unauthorized users.</p>

<p>The bad part of this chapter is that the discussed API does not exist. And probably won’t ever exist in Django.</p>

<p>But, there are other less-known projects (but ones that I help to maintain) that already have these features. Let’s see what you can do with them!</p>


    
      <h2 id="deal">
        
        <a class="anchor" href="#deal">deal</a>
        
      </h2>

<p><a href="https://github.com/life4/deal"><code class="language-plaintext highlighter-rouge">deal</code></a> is a library for <a href="https://en.wikipedia.org/wiki/Design_by_contract">Design-by-Contract</a>.</p>

<p>In other words, it allows decorating your functions and classes with some extra checks that are not representable by types (at least in Python-land).</p>

<p>Let’s say you have a function to divide two positive integers (which are just <code class="language-plaintext highlighter-rouge">int</code> in Python):</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">deal</span>

<span class="o">@</span><span class="n">deal</span><span class="p">.</span><span class="n">pre</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">b</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
<span class="o">@</span><span class="n">deal</span><span class="p">.</span><span class="n">raises</span><span class="p">(</span><span class="nb">ZeroDivisionError</span><span class="p">)</span>  <span class="c1"># this function can raise if `b=0`, it is ok
</span><span class="k">def</span> <span class="nf">div</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">/</span> <span class="n">b</span>
</code></pre></div></div>

<p>It has all the contract information in the function’s definition:</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">@deal.pre(lambda a, b: a &gt;= 0 and b &gt;= 0)</code> checks that passed arguments are positive</li>
  <li>
<code class="language-plaintext highlighter-rouge">@deal.raises(ZeroDivisionError)</code> allows this function to explicitly raise <code class="language-plaintext highlighter-rouge">ZeroDivisionError</code> without breaking the contract, by default functions cannot raise any exceptions</li>
</ul>

<p>Note: type annotations like in <code class="language-plaintext highlighter-rouge">(a: int, b: int) -&gt; float</code> are not enforced, you should use <code class="language-plaintext highlighter-rouge">mypy</code> to catch typing errors.</p>

<p>Usage (remember, it is still just a function!):</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">div</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># ok
</span><span class="n">div</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># ok, runtime ZeroDivisionError
</span>
<span class="n">div</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># not ok
# deal.PreContractError: expected a &gt;= 0 and b &gt;= 0 (where a=-1, b=1)
</span></code></pre></div></div>

<p>Ok, the simple use-case is clear. Now, let’s put a bug in this function on purpose:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">deal</span>

<span class="o">@</span><span class="n">deal</span><span class="p">.</span><span class="n">pre</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">b</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
<span class="o">@</span><span class="n">deal</span><span class="p">.</span><span class="n">raises</span><span class="p">(</span><span class="nb">ZeroDivisionError</span><span class="p">)</span>  <span class="c1"># this function can raise if `b=0`, it is ok
</span><span class="k">def</span> <span class="nf">div</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>  <span class="c1"># Custom, in real life this would be a bug in our logic:
</span>        <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="s">'Oh no! Bug happened!'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">/</span> <span class="n">b</span>
</code></pre></div></div>

<p>Luckily, <code class="language-plaintext highlighter-rouge">deal</code> follows the core idea of this article and ships tests with itself. To run them all we need to do is write just a single test case:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">deal</span>

<span class="kn">from</span> <span class="nn">my_lib</span> <span class="kn">import</span> <span class="n">div</span>

<span class="o">@</span><span class="n">deal</span><span class="p">.</span><span class="n">cases</span><span class="p">(</span><span class="n">div</span><span class="p">)</span>  <span class="c1"># That's all we have to do to test deal-based functions!
</span><span class="k">def</span> <span class="nf">test_div</span><span class="p">(</span><span class="n">case</span><span class="p">:</span> <span class="n">deal</span><span class="p">.</span><span class="n">TestCase</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">case</span><span class="p">()</span>
</code></pre></div></div>

<p>Here’s what the output would be like:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>» pytest test_deal.py
============================= test session starts ==============================
collected 1 item

test_deal.py F                                                            [100%]

=================================== FAILURES ===================================
___________________________________ test_div ___________________________________

a = 51, b = 0

    @deal.raises(ZeroDivisionError)
    @deal.pre(lambda a, b: a &gt;= 0 and b &gt;= 0)
    def div(a: int, b: int) -&gt; float:
        if a &gt; 50:
&gt;           raise Exception('Oh no! Bug happened!')
E           Exception: Oh no! Bug happened!

test_deal.py:8: Exception
============================== 1 failed in 0.35s ===============================
</code></pre></div></div>

<p>As you can see our tests did find the bug! But how?</p>

<p>There are a lot of questions to ask:</p>

<ul>
  <li>
    <p>Where did the data for the test come from?
It comes from another awesome library called <a href="https://github.com/HypothesisWorks/hypothesis"><code class="language-plaintext highlighter-rouge">hypothesis</code></a>. It smartly generates lots of different test data according to some specific rules we define.</p>

    <p>In our case, we have two rules. First rule generate two <code class="language-plaintext highlighter-rouge">int</code> arguments as defined in <code class="language-plaintext highlighter-rouge">def div(a: int, b: int)</code>. The second rule is that these integers must be <code class="language-plaintext highlighter-rouge">&gt;= 0</code> as defined in <code class="language-plaintext highlighter-rouge">@deal.pre(lambda a, b: a &gt;= 0 and b &gt;= 0)</code>.</p>

    <p>We can control how many examples would be generated and do other small tweaks.
More about it is in the <a href="https://deal.readthedocs.io/basic/tests.html">docs</a>.</p>
  </li>
  <li>
    <p>Why <code class="language-plaintext highlighter-rouge">ZeroDivisionError</code> didn’t break the test while raw <code class="language-plaintext highlighter-rouge">Exception</code> did?
Because that’s how contracts work: you clearly define all possible cases. If something strange happens - the contract is violated. In our example, <code class="language-plaintext highlighter-rouge">ZeroDivisionError</code> is a part of the contract via <code class="language-plaintext highlighter-rouge">deal.raises</code> decorator. So, we know that it can (and will) happen. That’s why we don’t treat it as a test failure, while raw <code class="language-plaintext highlighter-rouge">Exception</code> is not a part of our contract and we treat it as a failure.</p>
  </li>
  <li>
    <p>Will it find all bugs in my code?
That’s the most interesting question. And the answer is <strong>no</strong>. Sad, but true.
There are endless use-cases, logic, combitations, and bugs in them. And I know for sure that it is impossible to catch all bugs your app has.</p>

    <p>But, in reality, it will catch <strong>a lot</strong> of bugs. In my opinion, it is still worth it.</p>
  </li>
</ul>

<p>We can even go one step further and represent our contracts as <a href="https://github.com/Z3Prover/z3">Theorems to be proved</a>.
For example, <code class="language-plaintext highlighter-rouge">deal</code> has an ongoing research companion project - <a href="https://github.com/orsinium-labs/deal-solver"><code class="language-plaintext highlighter-rouge">deal-solver</code></a> - that can help with that. But, this is a subject for another article of its own, so let’s move on for now.</p>


    
      <h2 id="dry-pythonreturns">
        
        <a class="anchor" href="#dry-pythonreturns">dry-python/returns</a>
        
      </h2>

<p><a href="https://github.com/dry-python/returns"><code class="language-plaintext highlighter-rouge">dry-python/returns</code></a> is a library with primitives that make typed functional programming in Python easier.</p>

<p>Inside we have a bunch of interfaces that our users can extend for their own primitives/objects. In the recent article about <a href="https://sobolevn.me/2020/10/higher-kinded-types-in-python">Higher Kinded Types</a> I have shown how this can be done in a type-safe way.</p>

<p>Now, I am going to show that it is not enough on its own. And most likely you will need some extra laws on how your objects should behave.</p>

<p>We call this feature “Monad laws as values”.</p>


    
      <h3 id="identity-laws">
        
        <a class="anchor" href="#identity-laws">Identity laws</a>
        
      </h3>

<p>Let’s start from the easiest Higher Kinded Interface we have: <a href="https://github.com/dry-python/returns/blob/master/returns/interfaces/equable.py"><code class="language-plaintext highlighter-rouge">Equable</code></a>. It is an interface that allows type-safe equality checks. Because you can use <code class="language-plaintext highlighter-rouge">==</code> for everything in Python. But, our <code class="language-plaintext highlighter-rouge">.equals()</code> method will allow us to only check the object of the same type which has real values inside.</p>

<p>For example:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">returns.io</span> <span class="kn">import</span> <span class="n">IO</span>

<span class="n">IO</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>  <span class="c1"># type-checks, but pointless, always false
</span>
<span class="n">IO</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">equals</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># does not type-check at all
# error: Argument 1 has incompatible type "int";
# expected "KindN[IO[Any], Any, Any, Any]"
</span>
<span class="n">other</span><span class="p">:</span> <span class="n">IO</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
<span class="n">IO</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">equals</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>  <span class="c1"># ok, might be true or false
</span></code></pre></div></div>

<p>Here’s how it looks like at the moment:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">_EqualType</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s">'_EqualType'</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="s">'Equable'</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Equable</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="o">@</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">equals</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">_EqualType</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">_EqualType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="s">"""Type-safe equality check for values of the same type."""</span>
</code></pre></div></div>

<p>Let’s say we want to create a bad implementation for this interface (because of science):</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">returns.interfaces.equable</span> <span class="kn">import</span> <span class="n">Equable</span>

<span class="k">class</span> <span class="nc">Example</span><span class="p">(</span><span class="n">Equable</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inner_value</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_inner_value</span> <span class="o">=</span> <span class="n">inner_value</span>

    <span class="k">def</span> <span class="nf">equals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s">'Example'</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>  <span class="c1"># it breaks how `.equals` is supposed to be used!
</span></code></pre></div></div>

<p>It is clearly wrong because it always returns <code class="language-plaintext highlighter-rouge">False</code> without actually checking the <code class="language-plaintext highlighter-rouge">inner_value</code> of an object. But, it still satisfies the interface definition: it will type-check. That’s how we can tell that just the interface is not enough. We need to test the implementation as well.</p>

<p>But, equality has known laws from math to catch cases like this:</p>
<ul>
  <li>Reflexive law: a value must be equal to itself</li>
  <li>Symmetry law: <code class="language-plaintext highlighter-rouge">a.equals(b) == b.equals(a)</code>
</li>
  <li>Transitivity law: if <code class="language-plaintext highlighter-rouge">a</code> equals <code class="language-plaintext highlighter-rouge">b</code> and <code class="language-plaintext highlighter-rouge">b</code> equals <code class="language-plaintext highlighter-rouge">c</code>, then <code class="language-plaintext highlighter-rouge">a</code> equals <code class="language-plaintext highlighter-rouge">c</code>
</li>
</ul>

<p>We can create a test that will ensure that our implementation holds these laws. Or we might forget about it. Or make a mistake in our test logic.</p>

<p>That’s why it is important for library authors to think about their users and ship tests with their apps.</p>

<p>For example, we encode laws into the interface definition itself:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">ClassVar</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">TypeVar</span>

<span class="kn">from</span> <span class="nn">typing_extensions</span> <span class="kn">import</span> <span class="n">final</span>

<span class="kn">from</span> <span class="nn">returns.primitives.laws</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Law</span><span class="p">,</span>
    <span class="n">Law1</span><span class="p">,</span>
    <span class="n">Law2</span><span class="p">,</span>
    <span class="n">Law3</span><span class="p">,</span>
    <span class="n">Lawful</span><span class="p">,</span>
    <span class="n">LawSpecDef</span><span class="p">,</span>
    <span class="n">law_definition</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">_EqualType</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s">'_EqualType'</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="s">'Equable'</span><span class="p">)</span>


<span class="o">@</span><span class="n">final</span>
<span class="k">class</span> <span class="nc">_LawSpec</span><span class="p">(</span><span class="n">LawSpecDef</span><span class="p">):</span>  <span class="c1"># LOOKATME: our laws def!
</span>    <span class="o">@</span><span class="n">law_definition</span>
    <span class="k">def</span> <span class="nf">reflexive_law</span><span class="p">(</span>
        <span class="n">first</span><span class="p">:</span> <span class="n">_EqualType</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="s">"""Value should be equal to itself."""</span>
        <span class="k">assert</span> <span class="n">first</span><span class="p">.</span><span class="n">equals</span><span class="p">(</span><span class="n">first</span><span class="p">)</span>

    <span class="o">@</span><span class="n">law_definition</span>
    <span class="k">def</span> <span class="nf">symmetry_law</span><span class="p">(</span>
        <span class="n">first</span><span class="p">:</span> <span class="n">_EqualType</span><span class="p">,</span>
        <span class="n">second</span><span class="p">:</span> <span class="n">_EqualType</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="s">"""If ``A == B`` then ``B == A``."""</span>
        <span class="k">assert</span> <span class="n">first</span><span class="p">.</span><span class="n">equals</span><span class="p">(</span><span class="n">second</span><span class="p">)</span> <span class="o">==</span> <span class="n">second</span><span class="p">.</span><span class="n">equals</span><span class="p">(</span><span class="n">first</span><span class="p">)</span>

    <span class="o">@</span><span class="n">law_definition</span>
    <span class="k">def</span> <span class="nf">transitivity_law</span><span class="p">(</span>
        <span class="n">first</span><span class="p">:</span> <span class="n">_EqualType</span><span class="p">,</span>
        <span class="n">second</span><span class="p">:</span> <span class="n">_EqualType</span><span class="p">,</span>
        <span class="n">third</span><span class="p">:</span> <span class="n">_EqualType</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="s">"""If ``A == B`` and ``B == C`` then ``A == C``."""</span>
        <span class="k">if</span> <span class="n">first</span><span class="p">.</span><span class="n">equals</span><span class="p">(</span><span class="n">second</span><span class="p">)</span> <span class="ow">and</span> <span class="n">second</span><span class="p">.</span><span class="n">equals</span><span class="p">(</span><span class="n">third</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">first</span><span class="p">.</span><span class="n">equals</span><span class="p">(</span><span class="n">third</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Equable</span><span class="p">(</span><span class="n">Lawful</span><span class="p">[</span><span class="s">'Equable'</span><span class="p">]):</span>
    <span class="n">_laws</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Law</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Law1</span><span class="p">(</span><span class="n">_LawSpec</span><span class="p">.</span><span class="n">reflexive_law</span><span class="p">),</span>
        <span class="n">Law2</span><span class="p">(</span><span class="n">_LawSpec</span><span class="p">.</span><span class="n">symmetry_law</span><span class="p">),</span>
        <span class="n">Law3</span><span class="p">(</span><span class="n">_LawSpec</span><span class="p">.</span><span class="n">transitivity_law</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="o">@</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">equals</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">_EqualType</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">_EqualType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="s">"""Type-safe equality check for values of the same type."""</span>
</code></pre></div></div>

<p>That’s what I call “making tests a part of your app”!</p>

<p>Now, when we have laws in place, the only thing left to do is to enforce them. But, we need some data to do that. Luckily, we have <code class="language-plaintext highlighter-rouge">hypothesis</code> that can generate lots of random data for us.</p>

<p>So, here’s what we are going to do:</p>
<ol>
  <li>We will pass a class definition that has <code class="language-plaintext highlighter-rouge">_laws</code> property defined</li>
  <li>
<code class="language-plaintext highlighter-rouge">hypothesis</code> will get all its laws</li>
  <li>For each law we will generate a unique test case</li>
  <li>For each test case we will generate lots of input data to be sure that the law holds for any possible input</li>
</ol>

<p><a href="https://github.com/dry-python/returns/blob/master/returns/contrib/hypothesis/laws.py">Source code</a> for ones who are interested in the implementation details.</p>

<p>And we should provide a simple API for an end-user to do all these in one function call! That’s what we came up with:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test_example.py
</span><span class="kn">from</span> <span class="nn">returns.contrib.hypothesis.laws</span> <span class="kn">import</span> <span class="n">check_all_laws</span>
<span class="kn">from</span> <span class="nn">your_app</span> <span class="kn">import</span> <span class="n">Example</span>

<span class="n">check_all_laws</span><span class="p">(</span><span class="n">Example</span><span class="p">,</span> <span class="n">use_init</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<p>And here’s the result:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>» pytest test_example.py
============================ test session starts ===============================
collected 3 items

test_example.py .F.                                                   [100%]

=================================== FAILURES ===================================
____________________ test_Example_equable_reflexive_law _____________________
first = &lt;ex.Example object at 0x104d61b90&gt;

    @law_definition
    def reflexive_law(
        first: _EqualType,
    ) -&gt; None:
        """Value should be equal to itself."""
&gt;       assert first.equals(first)
E       AssertionError

returns/interfaces/equable.py:32: AssertionError
========================= 1 failed, 2 passed in 0.22s ==========================
</code></pre></div></div>

<p>As we can see <code class="language-plaintext highlighter-rouge">test_Example_equable_reflexive_law</code> fails, because <code class="language-plaintext highlighter-rouge">equals</code> always returns <code class="language-plaintext highlighter-rouge">False</code> in our <code class="language-plaintext highlighter-rouge">Example</code> class. And <code class="language-plaintext highlighter-rouge">reflexive_law</code> which states <code class="language-plaintext highlighter-rouge">(a == a) is True</code> does not hold.</p>

<p>We can refactor <code class="language-plaintext highlighter-rouge">Example</code> to use the correct logic with actually checking <code class="language-plaintext highlighter-rouge">inner_value</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Example</span><span class="p">(</span><span class="n">Equable</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inner_value</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_inner_value</span> <span class="o">=</span> <span class="n">inner_value</span>

    <span class="k">def</span> <span class="nf">equals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s">'Example'</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">_inner_value</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">_inner_value</span>  <span class="c1"># now we are talking!
</span></code></pre></div></div>

<p>And run our tests once again:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>» pytest test_example.py
============================= test session starts ==============================
collected 3 items

test_example.py ...                                                   [100%]

============================== 3 passed in 1.57s ===============================
</code></pre></div></div>

<p>But, we didn’t actually write a single test for <code class="language-plaintext highlighter-rouge">Example</code>. Instead, we wrote laws once and for all future implementations! That’s how caring about users looks like.</p>

<p>And again, awesome <code class="language-plaintext highlighter-rouge">hypothesis</code> helps us by generating random data to feed it into our tests (that’s why the package is called <code class="language-plaintext highlighter-rouge">returns.contrib.hypothesis.laws</code>).</p>


    
      <h3 id="other-functional-laws">
        
        <a class="anchor" href="#other-functional-laws">Other functional laws</a>
        
      </h3>

<p>Of course, <code class="language-plaintext highlighter-rouge">Equable</code> is not the only interface we have in <code class="language-plaintext highlighter-rouge">dry-python/returns</code>, we have <a href="https://github.com/dry-python/returns/tree/master/returns/interfaces">lots of them</a>, covering most of the traditional functional instances, read our <a href="https://returns.readthedocs.io/en/latest/pages/interfaces.html">docs</a> if you are interested.</p>

<p>These interfaces will help people if they are wondering what <a href="https://github.com/dry-python/returns/blob/master/returns/interfaces/container.py"><code class="language-plaintext highlighter-rouge">Monad</code></a> actually is and what laws it has.</p>

<p>Most of the interfaces have laws attached to the definition. This helps our users to be sure that their implementations are correct with as few steps as possible.</p>


    
      <h2 id="conclusion">
        
        <a class="anchor" href="#conclusion">Conclusion</a>
        
      </h2>

<p>Shipping tests with your app might be a very cool feature in some use-cases.</p>

<p>And use-cases are really-really different! As I have shown, they can vary from Web frameworks to architecture tools and math-ish libraries.</p>

<p>I would love to see more of this in the future. I hope that I have shown possible benefits for current and future library authors.</p>

    </div>

    <hr>

    <div class="post-subscribe">
      <h2>
        <a href="https://sobolevn.me/subscribe">
          Subscribe to my blog if you want more
        </a>
      </h2>
    </div>

    
    
    <div class="post-republish">
      <h4>Republished as:</h4>
      <ul>
      
        <li>
          <a class="c-article__repost" href="https://dev.to/sobolevn/make-tests-a-part-of-your-app-8nm" target="_blank">
            
            dev.to <img class="emoji" title=":us:" alt=":us:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f1fa-1f1f8.png" height="20" width="20">
          </a>
        </li>
      
      </ul>
    </div>
    
  </div>

  <!-- Disqus comments view -->
  
  <div class="post-disqus" id="discussion">
    <div id="disqus_thread"></div>

<script>
/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/

var disqus_config = function () {
this.page.url = "http://localhost:4000/2021/02/make-tests-a-part-of-your-app";
this.page.identifier = "/2021/02/make-tests-a-part-of-your-app";
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://sobolevn-me.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>

  </div>
  
</article>

  </div>
  <footer class="c-page__footer">
  <p>
    <i class="far fa-copyright"></i>
    <a href="https://sobolevn.me/about/">sobolevn</a>
    2023,
    content licensed
    <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">
      CC BY-NC
    </a>,
    <a href="https://github.com/sobolevn/sobolevn.github.io" target="_blank">
      source code
    </a>
  </p>

  <p>
    <a href="mailto:mail@sobolevn.me" alt="email">
      <i class="far fa-2x fa-envelope"></i>
    </a>
    <a href="https://github.com/sobolevn" alt="github">
      <i class="fab fa-2x fa-github"></i>
    </a>
    <a href="https://dev.to/sobolevn" alt="practicaldev">
      <i class="fab fa-2x fa-dev"></i>
    </a>
    <a href="https://medium.com/@sobolevn" alt="medium">
      <i class="fab fa-2x fa-medium"></i>
    </a>
    <a href="https://stackoverflow.com/users/4842742/sobolevn" alt="stackoverflow">
      <i class="fab fa-2x fa-stack-overflow"></i>
    </a>
  </p>
</footer>

</div>

    </main>

    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-66588818-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-66588818-1');
</script>

  </body>
</html>
