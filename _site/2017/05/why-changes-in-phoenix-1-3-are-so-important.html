<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Favicon -->
  <link rel="apple-touch-icon" sizes="57x57" href="/assets/images/favicons/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/assets/images/favicons/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/assets/images/favicons/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/assets/images/favicons/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/assets/images/favicons/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/assets/images/favicons/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/assets/images/favicons/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/assets/images/favicons/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/images/favicons/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192"  href="/assets/images/favicons/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/assets/images/favicons/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/images/favicons/manifest.json">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/assets/images/favicons/ms-icon-144x144.png">
<meta name="theme-color" content="#ffffff">


  <!-- Meta information -->
  <title>Why changes in Phoenix 1.3 are so important?</title>
  <meta name="description"
        content="">
  <link rel="canonical"
        href="http://localhost:4000/2017/05/why-changes-in-phoenix-1-3-are-so-important" />

  <!-- Open search scheme -->
  <link rel="search"
        type="application/opensearchdescription+xml"
        title="sobolevn.me"
        href="/opensearch.xml" />

  <!-- Feed -->
  <link rel="alternate" type="application/rss+xml" title="sobolevn's personal blog"
        href="/feed.xml" />

  <!-- Custom fonts -->
  <link href="https://fonts.googleapis.com/css?family=Merriweather:400,400i,900|Roboto+Mono:400,400i|Montserrat:400,800" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">

  <!-- Custom style -->
  <link rel="stylesheet" href="/css/main.css" />

  <!-- Global site tag (gtag.js) - Google Ads: 839642990 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=AW-839642990"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'AW-839642990');
  </script>
</head>


  <body>
    <main class="u-container">
      <div class="c-page">
  <header class="c-page__header">
  <h1><code>sobolevn's personal blog</code></h1>

  

  <nav role="navigation">
    <a href="/" role="menuitem">
      Blog
    </a>

    <span class="u-separate"></span>
    <a href="/talks/" role="menuitem">
      Talks
    </a>

    <span class="u-separate"></span>
    <a href="/activities/" role="menuitem">
      Activities
    </a>

    <span class="u-separate"></span>
    <a href="/about/" role="menuitem">
      About
    </a>

    <span class="u-separate"></span>
    <a href="/subscribe/" role="menuitem">
      Subscribe
    </a>
  </nav>
</header>

  <div class="c-page__main">
    <article class="c-article" itemscope="" itemtype="http://schema.org/BlogPosting">
  <header class="c-article__header">
    <h1 class="c-article__title" itemprop="name">Why changes in Phoenix 1.3 are so important?</h1>
    <p class="c-article__time">
      <small>
        <time datetime="2017-05-14T00:00:00+05:30" itemprop="datePublished">
          May 14, 2017
        </time>
      </small>
      <small><span class="reading-time" title="Estimated read time">
  
  
    14 mins
   read
</span>
</small>
      <small><a href="#discussion">Start a discussion</a></small>
      <small><a href="https://github.com/sobolevn/sobolevn.github.io/blob/master/_posts/2017-05-14-why-changes-in-phoenix-1-3-are-so-important.md">Edit this page</a></small>
    </p>
  </header>

  <!-- Post Tags -->
  <!-- <ul class="c-tags">
    
    <li class="c-tag">elixir</li>
    
    <li class="c-tag">phoenix</li>
    
  </ul> -->

  <!-- Content -->
  <div class="c-article__main">

    

    <div class="c-article__body" itemprop="articleBody">
      <p><img src="https://cdn-images-1.medium.com/max/1200/1*THRh4--2uAqVuBM_Iab78A.png" alt="Phoenix logo"></p>

<p>Phoenix Framework always has been awesome. But it was never as awesome as the new <code class="language-plaintext highlighter-rouge">1.3</code> release (which is <code class="language-plaintext highlighter-rouge">rc1</code> right now actually).</p>

<p>There are a lot of significant changes. Chris McCord made a great job writing a <a href="https://gist.github.com/chrismccord/71ab10d433c98b714b75c886eff17357">complete migrating guide</a>. Inspired by it and by the <a href="https://www.youtube.com/watch?v=tMO28ar0lW8">talk</a> Chris gave at the LonestarElixir this article will try to guide through the most important changes in the phoenix project.</p>

<p>Let’s get started!</p>


      <h2 id="problems-to-solve">
        
        <a class="anchor" href="#problems-to-solve">Problems to solve</a>
        
      </h2>

<p><code class="language-plaintext highlighter-rouge">phoenix</code> is new. And naturally it has some issues. The core team has worked really hard to solve some of the most curial ones in the newest release. So what are these issues?</p>


    
      <h3 id="web-folder-is-pure-magic">
        
        <a class="anchor" href="#web-folder-is-pure-magic">Web folder is pure magic</a>
        
      </h3>

<p>When working on a project using <code class="language-plaintext highlighter-rouge">phoenix</code>, you have two places for the source code: <code class="language-plaintext highlighter-rouge">lib/</code> and <code class="language-plaintext highlighter-rouge">web/</code>. The concept is:</p>

<ol>
  <li>
    <p>Put all your business logic and utilities inside <code class="language-plaintext highlighter-rouge">lib/</code></p>
  </li>
  <li>
    <p>Put everything that relates with your web-interface (controllers, views, templates) inside the <code class="language-plaintext highlighter-rouge">web/</code> folder</p>
  </li>
</ol>

<p>But is that message clear enough for the developers? I don’t think so.</p>

<p>Where did this <code class="language-plaintext highlighter-rouge">web/</code> folder come from? Is it a <code class="language-plaintext highlighter-rouge">phoenix</code> special? Or other frameworks use it too? Should I even use <code class="language-plaintext highlighter-rouge">lib/</code> with <code class="language-plaintext highlighter-rouge">phoenix</code> projects or is it reserved for some deep magic? All these questions ran through my head after my first encounter with <code class="language-plaintext highlighter-rouge">phoenix</code>.</p>

<p>Before version <code class="language-plaintext highlighter-rouge">1.2</code> <code class="language-plaintext highlighter-rouge">web/</code> was the only one to auto-reload. So, why should I create any files inside <code class="language-plaintext highlighter-rouge">lib/</code> and restart a server when I can put it somewhere inside <code class="language-plaintext highlighter-rouge">web/</code> to reload quickly?</p>

<p>Which brings us to even more important questions: do my model files (let’s call them models in this particular context) belong to the web part of my application or to my core logic? Is it possible to separate my logic into different domains or apps (like in <code class="language-plaintext highlighter-rouge">django</code>)?</p>

<p>These questions are left unanswered.</p>


    
      <h3 id="business-logic-in-controllers">
        
        <a class="anchor" href="#business-logic-in-controllers">Business logic in controllers</a>
        
      </h3>

<p>Moreover, the boilerplate code, which comes with the <code class="language-plaintext highlighter-rouge">phoenix</code> itself, was promoting the other way of doing things. One would get these lines of code with the newly generated project:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">Example</span><span class="o">.</span><span class="no">UserController</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">Example</span><span class="o">.</span><span class="no">Web</span><span class="p">,</span> <span class="ss">:controller</span>

  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="n">update</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="p">%{</span><span class="s2">"id"</span> <span class="o">=&gt;</span> <span class="n">id</span><span class="p">,</span> <span class="s2">"user"</span> <span class="o">=&gt;</span> <span class="n">user_params</span><span class="p">})</span> <span class="k">do</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">Repo</span><span class="o">.</span><span class="n">get!</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="n">id</span><span class="p">)</span>
    <span class="n">changeset</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">changeset</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">user_params</span><span class="p">)</span>

    <span class="k">case</span> <span class="no">Repo</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">changeset</span><span class="p">)</span> <span class="k">do</span>
      <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">user</span><span class="p">}</span> <span class="o">-&gt;</span>
        <span class="n">render</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="no">Example</span><span class="o">.</span><span class="no">UserView</span><span class="p">,</span> <span class="s2">"show.json"</span><span class="p">,</span> <span class="ss">user:</span> <span class="n">user</span><span class="p">)</span>
      <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="n">changeset</span><span class="p">}</span> <span class="o">-&gt;</span>
        <span class="n">conn</span>
        <span class="o">|&gt;</span> <span class="n">put_status</span><span class="p">(</span><span class="ss">:unprocessable_entity</span><span class="p">)</span>
        <span class="o">|&gt;</span> <span class="n">render</span><span class="p">(</span><span class="no">Example</span><span class="o">.</span><span class="no">ChangesetView</span><span class="p">,</span> <span class="s2">"error.json"</span><span class="p">,</span> <span class="ss">changeset:</span> <span class="n">changeset</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>What should a developer do when an email should be sent to a user after a successful update? The controller itself asks to be extended. Just put a new line of code before render/4. But that’s a wrong way of doing things. And it was kind of promoted by the <code class="language-plaintext highlighter-rouge">phoenix</code> itself.</p>

<p>One extra line in the controller is fine, that’s not a big deal. All the problems come when the application grows. It becomes untestable, unmaintainable, and self-repeating.</p>


    
      <h3 id="schemas-are-not-models">
        
        <a class="anchor" href="#schemas-are-not-models">Schemas are not models</a>
        
      </h3>

<p>At some point for no particular reason <code class="language-plaintext highlighter-rouge">ecto</code>’s schemas started to be called “models”. What is the difference between a “model” and a “schema”? Schema is just a way to define a structure - a database structure at this particular case. Models as a concept are much more complex than schemas. Models should provide a way to manipulate data and perform different actions, like models in <code class="language-plaintext highlighter-rouge">django</code>. <code class="language-plaintext highlighter-rouge">elixir</code> as a functional language is not suited for the “model” concept, so it was <a href="https://hexdocs.pm/ecto/1.1.0/Ecto.Model.html">deprecated</a> a long time ago in the <code class="language-plaintext highlighter-rouge">ecto</code> project.</p>

<p>Files inside <code class="language-plaintext highlighter-rouge">models/</code> were not organized. When your application grew, it became a complete <a href="https://github.com/elixir-lang-moscow/site/tree/master/web/models">mess</a>. How these files are bounded? What is the context we use them in? It was hard to figure that out.</p>

<p>Furthermore, <code class="language-plaintext highlighter-rouge">models/</code> folder was considered as a place to <a href="https://elixirforum.com/t/where-is-the-best-place-for-additional-model-functionality/3478/4">put your business logic</a>, which is a normal thing to do in other languages and frameworks. We have a concept of “fat models”, with which we are already familiar. But in <code class="language-plaintext highlighter-rouge">phoenix</code> it is just one more wrong way of doing it.</p>


    
      <h2 id="solutions">
        
        <a class="anchor" href="#solutions">Solutions</a>
        
      </h2>

<p>A lot has changed since the last major release. The easiest way to show all the changes is by example.</p>


    
      <h3 id="requirements">
        
        <a class="anchor" href="#requirements">Requirements</a>
        
      </h3>

<p>This tutorial assumes that you have <code class="language-plaintext highlighter-rouge">elixir-1.4</code> up and running. No? Then <a href="http://elixir-lang.org/install.html">install it</a>!</p>


    
      <h3 id="installation">
        
        <a class="anchor" href="#installation">Installation</a>
        
      </h3>

<p>Firstly, you would need to install new <code class="language-plaintext highlighter-rouge">phoenix</code> release:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mix archive.install https://github.com/phoenixframework/archives/raw/master/phx_new.ez
</code></pre></div></div>


    
      <h3 id="creating-new-project">
        
        <a class="anchor" href="#creating-new-project">Creating new project</a>
        
      </h3>

<p>When installation is completed, it is time to check that everything is in place. mix help will return you something like this:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mix phoenix.new       <span class="c"># Creates a new Phoenix v1.1.4 application</span>

mix phx.new           <span class="c"># Creates a new Phoenix v1.3.0-rc.1 application using the experimental generators</span>
</code></pre></div></div>

<p>That’s where the <strong>first change</strong> comes in: new generators. Old generators were named <code class="language-plaintext highlighter-rouge">phoenix</code> while the new ones are named simply <code class="language-plaintext highlighter-rouge">phx</code>. Less typing. And a new message to the developers: these generators are new, they will do new things to your codebase.</p>

<p>Then, it is time to create new project’s structure by running:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mix phx.new medium_phx_example <span class="nt">--no-html</span> <span class="nt">--no-brunch</span>
</code></pre></div></div>

<p>Before we see any results of this command, let’s discuss the options. <code class="language-plaintext highlighter-rouge">--no-html</code> removes some specific components so <code class="language-plaintext highlighter-rouge">phx.gen.html</code> will no longer work. But we are building <code class="language-plaintext highlighter-rouge">json</code> API and we won’t need any <code class="language-plaintext highlighter-rouge">html</code>. Similarly <code class="language-plaintext highlighter-rouge">--no-brunch</code> means: do not generate <code class="language-plaintext highlighter-rouge">brunch</code> files for static asset building. When choosing this option, you will need to manually handle JavaScript dependencies if building <code class="language-plaintext highlighter-rouge">html</code> apps.</p>


    
      <h2 id="changes">
        
        <a class="anchor" href="#changes">Changes</a>
        
      </h2>


    
      <h3 id="web-folder">
        
        <a class="anchor" href="#web-folder">Web folder</a>
        
      </h3>

<p>Looking at your newly generated files you may be wondering: where is the <code class="language-plaintext highlighter-rouge">web/</code> folder? Well, here is the <strong>second change</strong>. And it’s big. Now your web/ folder lives inside <code class="language-plaintext highlighter-rouge">lib/</code>. This <code class="language-plaintext highlighter-rouge">web/</code> folder was special; a lot of people misunderstood its main purpose, which was containing web interface for your application. It’s not a place for your business logic. Now things are clear. Put everything inside <code class="language-plaintext highlighter-rouge">lib/</code>. And put only your controllers, templates and views inside the new <code class="language-plaintext highlighter-rouge">web/</code>.</p>

<p>That’s how it looks:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lib
└── medium_phx_example
    ├── application.ex
    ├── repo.ex
    └── web
        ├── channels
        │   └── user_socket.ex
        ├── controllers
        ├── endpoint.ex
        ├── gettext.ex
        ├── router.ex
        ├── views
        │   ├── error_helpers.ex
        │   └── error_view.ex
        └── web.ex
</code></pre></div></div>

<p>Where <code class="language-plaintext highlighter-rouge">medium_phx_example</code> is the name of the current app. There can be many apps. So now all the code lives inside the same folder.</p>

<p>The <strong>third change</strong> will reveal itself shortly after looking at the web.ex file:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">MediumPhxExample</span><span class="o">.</span><span class="no">Web</span> <span class="k">do</span>
  <span class="k">def</span> <span class="n">controller</span> <span class="k">do</span>
    <span class="kn">quote</span> <span class="k">do</span>
      <span class="kn">use</span> <span class="no">Phoenix</span><span class="o">.</span><span class="no">Controller</span><span class="p">,</span> <span class="ss">namespace:</span> <span class="no">MediumPhxExample</span><span class="o">.</span><span class="no">Web</span>
      <span class="kn">import</span> <span class="no">Plug</span><span class="o">.</span><span class="no">Conn</span>
      <span class="c1"># Before 1.3 it was just:</span>
      <span class="c1"># import MediumPhxExample.Router.Helpers</span>
      <span class="kn">import</span> <span class="no">MediumPhxExample</span><span class="o">.</span><span class="no">Web</span><span class="o">.</span><span class="no">Router</span><span class="o">.</span><span class="no">Helpers</span>
      <span class="kn">import</span> <span class="no">MediumPhxExample</span><span class="o">.</span><span class="no">Web</span><span class="o">.</span><span class="no">Gettext</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="c1"># Some extra code:</span>
  <span class="c1"># ...</span>

<span class="k">end</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">phoenix</code> now creates <code class="language-plaintext highlighter-rouge">.Web</code> namespace for us, which pairs really well with the new folder structure.</p>


    
      <h3 id="creating-schema">
        
        <a class="anchor" href="#creating-schema">Creating schema</a>
        
      </h3>

<p>That’s the <strong>forth change</strong> and my favorite one so far. Previously we had a <code class="language-plaintext highlighter-rouge">web/models/</code> folder, which was used to store schemas. Now “model” concept is completely dead. A new philosophy of doing things is introduced:</p>

<ol>
  <li>
    <p>Context is used to store multiple schemas</p>
  </li>
  <li>
    <p>Context is used to provide a public external API. In other words, it defines what can be done to your data</p>
  </li>
  <li>
    <p>Schema is just a description of your data</p>
  </li>
</ol>

<p>Our application would contain just one context: audios. Let’s start by creating Audio context with Album and Song schemas:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mix phx.gen.json Audio Album albums name:string release:utc_datetime

mix phx.gen.json Audio Song songs album_id:references:audio_albums name:string duration:integer
</code></pre></div></div>

<p>The syntax of this generator has also changed. Now it requires the context name to be the first argument. Also take note of the <code class="language-plaintext highlighter-rouge">audio_albums</code> notation, albums schema is prefixed with the context name. And here’s what happens to the project structure after we run two generators:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lib
└── medium_phx_example
├── application.ex
├── audio
│   ├── album.ex
│   ├── audio.ex
│   └── song.ex
├── repo.ex
└── web
    ├── channels
    │   └── user_socket.ex
    ├── controllers
    │   ├── album_controller.ex
    │   ├── fallback_controller.ex
    │   └── song_controller.ex
    ├── endpoint.ex
    ├── gettext.ex
    ├── router.ex
    ├── views
    │   ├── album_view.ex
    │   ├── changeset_view.ex
    │   ├── error_helpers.ex
    │   ├── error_view.ex
    │   └── song_view.ex
    └── web.ex
</code></pre></div></div>

<p>What are the main changes in the structures compared to the previous version?</p>

<ol>
  <li>
    <p>Now schemas do not belong to <code class="language-plaintext highlighter-rouge">web/</code> at all</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">models/</code> folder is gone</p>
  </li>
  <li>
    <p>Schemas are now separated by context, which defines how they are bounded together</p>
  </li>
</ol>

<p>And schemas right now are nothing more than a table description. That’s what a schema is in the first place. Here’s what our schemas look like:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># album.ex</span>
<span class="k">defmodule</span> <span class="no">MediumPhxExample</span><span class="o">.</span><span class="no">Audio</span><span class="o">.</span><span class="no">Album</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">Ecto</span><span class="o">.</span><span class="no">Schema</span>

  <span class="n">schema</span> <span class="s2">"audio_albums"</span> <span class="k">do</span>
    <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:string</span>
    <span class="n">field</span> <span class="ss">:release</span><span class="p">,</span> <span class="ss">:utc_datetime</span>

    <span class="n">timestamps</span><span class="p">()</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># song.ex</span>
<span class="k">defmodule</span> <span class="no">MediumPhxExample</span><span class="o">.</span><span class="no">Audio</span><span class="o">.</span><span class="no">Song</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">Ecto</span><span class="o">.</span><span class="no">Schema</span>

  <span class="n">schema</span> <span class="s2">"audio_songs"</span> <span class="k">do</span>
    <span class="n">field</span> <span class="ss">:duration</span><span class="p">,</span> <span class="ss">:integer</span>
    <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:string</span>
    <span class="n">field</span> <span class="ss">:album_id</span><span class="p">,</span> <span class="ss">:id</span>

    <span class="n">timestamps</span><span class="p">()</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Everything except schema declaration is gone. No <code class="language-plaintext highlighter-rouge">required_fields</code>, no <code class="language-plaintext highlighter-rouge">changeset/2</code> function or any other functions and logics. It <a href="https://github.com/phoenixframework/phoenix/issues/2151">does not even generate</a> <code class="language-plaintext highlighter-rouge">belongs_to</code> for you.</p>

<p>So, it is pretty clear now: this is not a place for your business logic. It is all handled by the context, which looks the following way:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># audio.ex</span>
<span class="k">defmodule</span> <span class="no">MediumPhxExample</span><span class="o">.</span><span class="no">Audio</span> <span class="k">do</span>
  <span class="nv">@moduledoc</span> <span class="sd">"""
  The boundary for the Audio system.
  """</span>

  <span class="kn">import</span> <span class="no">Ecto</span><span class="o">.</span><span class="p">{</span><span class="no">Query</span><span class="p">,</span> <span class="no">Changeset</span><span class="p">},</span> <span class="ss">warn:</span> <span class="no">false</span>
  <span class="n">alias</span> <span class="no">MediumPhxExample</span><span class="o">.</span><span class="no">Repo</span>

  <span class="n">alias</span> <span class="no">MediumPhxExample</span><span class="o">.</span><span class="no">Audio</span><span class="o">.</span><span class="no">Album</span>

  <span class="k">def</span> <span class="n">list_albums</span> <span class="k">do</span>
    <span class="no">Repo</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="no">Album</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">get_album!</span><span class="p">(</span><span class="n">id</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="no">Repo</span><span class="o">.</span><span class="n">get!</span><span class="p">(</span><span class="no">Album</span><span class="p">,</span> <span class="n">id</span><span class="p">)</span>

  <span class="k">def</span> <span class="n">create_album</span><span class="p">(</span><span class="n">attrs</span> <span class="p">\\</span> <span class="p">%{})</span> <span class="k">do</span>
    <span class="p">%</span><span class="no">Album</span><span class="p">{}</span>
    <span class="o">|&gt;</span> <span class="n">album_changeset</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
    <span class="o">|&gt;</span> <span class="no">Repo</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>

  <span class="k">defp</span> <span class="n">album_changeset</span><span class="p">(%</span><span class="no">Album</span><span class="p">{}</span> <span class="o">=</span> <span class="n">album</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">album</span>
    <span class="o">|&gt;</span> <span class="n">cast</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="p">[</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:release</span><span class="p">])</span>
    <span class="o">|&gt;</span> <span class="n">validate_required</span><span class="p">([</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:release</span><span class="p">])</span>
  <span class="k">end</span>

  <span class="n">alias</span> <span class="no">MediumPhxExample</span><span class="o">.</span><span class="no">Audio</span><span class="o">.</span><span class="no">Song</span>

  <span class="k">def</span> <span class="n">list_songs</span> <span class="k">do</span>
    <span class="no">Repo</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="no">Song</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">get_song!</span><span class="p">(</span><span class="n">id</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="no">Repo</span><span class="o">.</span><span class="n">get!</span><span class="p">(</span><span class="no">Song</span><span class="p">,</span> <span class="n">id</span><span class="p">)</span>

  <span class="k">def</span> <span class="n">create_song</span><span class="p">(</span><span class="n">attrs</span> <span class="p">\\</span> <span class="p">%{})</span> <span class="k">do</span>
    <span class="p">%</span><span class="no">Song</span><span class="p">{}</span>
    <span class="o">|&gt;</span> <span class="n">song_changeset</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
    <span class="o">|&gt;</span> <span class="no">Repo</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>

  <span class="k">defp</span> <span class="n">song_changeset</span><span class="p">(%</span><span class="no">Song</span><span class="p">{}</span> <span class="o">=</span> <span class="n">song</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">song</span>
    <span class="o">|&gt;</span> <span class="n">cast</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="p">[</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:duration</span><span class="p">])</span>
    <span class="o">|&gt;</span> <span class="n">validate_required</span><span class="p">([</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:duration</span><span class="p">])</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>It also sends a clear message: this is the place where one should put their code! But be careful, context files can grow long. Split them in several modules in that case.</p>


    
      <h3 id="using-controller">
        
        <a class="anchor" href="#using-controller">Using controller</a>
        
      </h3>

<p>Previously we had a lot of code in the controller by default. It was easy for a developer to extend the boilerplate code. Here comes the <strong>fifth change</strong>. Since the new release the boilerplate code in the controller has been reduced and refactored:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">MediumPhxExample</span><span class="o">.</span><span class="no">Web</span><span class="o">.</span><span class="no">AlbumController</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">MediumPhxExample</span><span class="o">.</span><span class="no">Web</span><span class="p">,</span> <span class="ss">:controller</span>

  <span class="n">alias</span> <span class="no">MediumPhxExample</span><span class="o">.</span><span class="no">Audio</span>
  <span class="n">alias</span> <span class="no">MediumPhxExample</span><span class="o">.</span><span class="no">Audio</span><span class="o">.</span><span class="no">Album</span>

  <span class="n">action_fallback</span> <span class="no">MediumPhxExample</span><span class="o">.</span><span class="no">Web</span><span class="o">.</span><span class="no">FallbackController</span>

  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="n">update</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="p">%{</span><span class="s2">"id"</span> <span class="o">=&gt;</span> <span class="n">id</span><span class="p">,</span> <span class="s2">"album"</span> <span class="o">=&gt;</span> <span class="n">album_params</span><span class="p">})</span> <span class="k">do</span>
    <span class="n">album</span> <span class="o">=</span> <span class="no">Audio</span><span class="o">.</span><span class="n">get_album!</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>

    <span class="n">with</span> <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="p">%</span><span class="no">Album</span><span class="p">{}</span> <span class="o">=</span> <span class="n">album</span><span class="p">}</span> <span class="o">&lt;-</span> <span class="no">Audio</span><span class="o">.</span><span class="n">update_album</span><span class="p">(</span><span class="n">album</span><span class="p">,</span> <span class="n">album_params</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">render</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="s2">"show.json"</span><span class="p">,</span> <span class="ss">album:</span> <span class="n">album</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>

<span class="k">end</span>
</code></pre></div></div>

<p>There are only three meaning lines of code in the <code class="language-plaintext highlighter-rouge">update/2</code> action right now. Controllers currently use contexts directly, which makes them a very thin layer in the application. It is hard to find a place for some extra logic in the controller. Controllers do not even handle errors.</p>

<p>Errors are designed to be handled by a special <code class="language-plaintext highlighter-rouge">fallback_controller</code>. This new concept is the <strong>sixth change</strong>. It allows to have all error handlers and error codes in the one place:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">MediumPhxExample</span><span class="o">.</span><span class="no">Web</span><span class="o">.</span><span class="no">FallbackController</span> <span class="k">do</span>
  <span class="nv">@moduledoc</span> <span class="sd">"""
  Translates controller action results into valid `Plug.Conn` responses.
  See `Phoenix.Controller.action_fallback/1` for more details.
  """</span>
  <span class="kn">use</span> <span class="no">MediumPhxExample</span><span class="o">.</span><span class="no">Web</span><span class="p">,</span> <span class="ss">:controller</span>

  <span class="k">def</span> <span class="n">call</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="p">%</span><span class="no">Ecto</span><span class="o">.</span><span class="no">Changeset</span><span class="p">{}</span> <span class="o">=</span> <span class="n">changeset</span><span class="p">})</span> <span class="k">do</span>
    <span class="n">conn</span>
    <span class="o">|&gt;</span> <span class="n">put_status</span><span class="p">(</span><span class="ss">:unprocessable_entity</span><span class="p">)</span>
    <span class="o">|&gt;</span> <span class="n">render</span><span class="p">(</span><span class="no">MediumPhxExample</span><span class="o">.</span><span class="no">Web</span><span class="o">.</span><span class="no">ChangesetView</span><span class="p">,</span> <span class="s2">"error.json"</span><span class="p">,</span> <span class="ss">changeset:</span> <span class="n">changeset</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">call</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="ss">:not_found</span><span class="p">})</span> <span class="k">do</span>
    <span class="n">conn</span>
    <span class="o">|&gt;</span> <span class="n">put_status</span><span class="p">(</span><span class="ss">:not_found</span><span class="p">)</span>
    <span class="o">|&gt;</span> <span class="n">render</span><span class="p">(</span><span class="no">MediumPhxExample</span><span class="o">.</span><span class="no">Web</span><span class="o">.</span><span class="no">ErrorView</span><span class="p">,</span> <span class="ss">:"404"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>What happens when the result from <code class="language-plaintext highlighter-rouge">Audio.update_album(album, album_params)</code> does not match with <code class="language-plaintext highlighter-rouge">{:ok, %Album{} = album}</code>? In this situation a controller defined in <code class="language-plaintext highlighter-rouge">action_fallback</code> is called. And a proper <code class="language-plaintext highlighter-rouge">call/2</code> is pattern matched, which returns a valid response. Nice and easy. No more exception handling in the controller.</p>


    
      <h2 id="conclusion">
        
        <a class="anchor" href="#conclusion">Conclusion</a>
        
      </h2>

<p>All things said the changes introduced are quite exciting. Hope this article was helpful and encouraged you to get out there and use Phoenix Framework to its maximum.</p>

    </div>

    <hr>

    <div class="post-subscribe">
      <h2>
        <a href="https://sobolevn.me/subscribe">
          Subscribe to my blog if you want more
        </a>
      </h2>
    </div>

    
    
    <div class="post-republish">
      <h4>Republished as:</h4>
      <ul>
      
        <li>
          <a class="c-article__repost" href="https://medium.com/wemake-services/why-changes-in-phoenix-1-3-are-so-important-2d50c9bdabb9" target="_blank">
            
            medium.com <img class="emoji" title=":us:" alt=":us:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f1fa-1f1f8.png" height="20" width="20">
          </a>
        </li>
      
      </ul>
    </div>
    
  </div>

  <!-- Disqus comments view -->
  
  <div class="post-disqus" id="discussion">
    <div id="disqus_thread"></div>

<script>
/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/

var disqus_config = function () {
this.page.url = "http://localhost:4000/2017/05/why-changes-in-phoenix-1-3-are-so-important";
this.page.identifier = "/2017/05/why-changes-in-phoenix-1-3-are-so-important";
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://sobolevn-me.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>

  </div>
  
</article>

  </div>
  <footer class="c-page__footer">
  <p>
    <i class="far fa-copyright"></i>
    <a href="https://sobolevn.me/about/">sobolevn</a>
    2023,
    content licensed
    <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">
      CC BY-NC
    </a>,
    <a href="https://github.com/sobolevn/sobolevn.github.io" target="_blank">
      source code
    </a>
  </p>

  <p>
    <a href="mailto:mail@sobolevn.me" alt="email">
      <i class="far fa-2x fa-envelope"></i>
    </a>
    <a href="https://github.com/sobolevn" alt="github">
      <i class="fab fa-2x fa-github"></i>
    </a>
    <a href="https://dev.to/sobolevn" alt="practicaldev">
      <i class="fab fa-2x fa-dev"></i>
    </a>
    <a href="https://medium.com/@sobolevn" alt="medium">
      <i class="fab fa-2x fa-medium"></i>
    </a>
    <a href="https://stackoverflow.com/users/4842742/sobolevn" alt="stackoverflow">
      <i class="fab fa-2x fa-stack-overflow"></i>
    </a>
  </p>
</footer>

</div>

    </main>

    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-66588818-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-66588818-1');
</script>

  </body>
</html>
