<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Favicon -->
  <link rel="apple-touch-icon" sizes="57x57" href="/assets/images/favicons/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/assets/images/favicons/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/assets/images/favicons/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/assets/images/favicons/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/assets/images/favicons/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/assets/images/favicons/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/assets/images/favicons/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/assets/images/favicons/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/images/favicons/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192"  href="/assets/images/favicons/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/assets/images/favicons/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/images/favicons/manifest.json">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/assets/images/favicons/ms-icon-144x144.png">
<meta name="theme-color" content="#ffffff">


  <!-- Meta information -->
  <title>Testing Django Migrations</title>
  <meta name="description"
        content="Dear internet,">
  <link rel="canonical"
        href="http://localhost:4000/2019/10/testing-django-migrations" />

  <!-- Open search scheme -->
  <link rel="search"
        type="application/opensearchdescription+xml"
        title="sobolevn.me"
        href="/opensearch.xml" />

  <!-- Feed -->
  <link rel="alternate" type="application/rss+xml" title="rishi raj's blog"
        href="/feed.xml" />

  <!-- Custom fonts -->
  <link href="https://fonts.googleapis.com/css?family=Merriweather:400,400i,900|Roboto+Mono:400,400i|Montserrat:400,800" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">

  <!-- Custom style -->
  <link rel="stylesheet" href="/css/main.css" />

  <!-- Global site tag (gtag.js) - Google Ads: 839642990 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=AW-839642990"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'AW-839642990');
  </script>
</head>


  <body>
    <main class="u-container">
      <div class="c-page">
  <header class="c-page__header">
  <h1><code>rishi raj's blog</code></h1>

  

  <nav role="navigation">
    <a href="/" role="menuitem">
      Blog
    </a>

    <span class="u-separate"></span>
    <a href="/talks/" role="menuitem">
      Talks
    </a>

    <span class="u-separate"></span>
    <a href="/activities/" role="menuitem">
      Activities
    </a>

    <span class="u-separate"></span>
    <a href="/about/" role="menuitem">
      About
    </a>

    <span class="u-separate"></span>
    <a href="/subscribe/" role="menuitem">
      Subscribe
    </a>
  </nav>
</header>

  <div class="c-page__main">
    <article class="c-article" itemscope="" itemtype="http://schema.org/BlogPosting">
  <header class="c-article__header">
    <h1 class="c-article__title" itemprop="name">Testing Django Migrations</h1>
    <p class="c-article__time">
      <small>
        <time datetime="2019-10-13T00:00:00+05:30" itemprop="datePublished">
          October 13, 2019
        </time>
      </small>
      <small><span class="reading-time" title="Estimated read time">
  
  
    7 mins
   read
</span>
</small>
      <small><a href="#discussion">Start a discussion</a></small>
      <small><a href="https://github.com/sobolevn/sobolevn.github.io/blob/master/_posts/2019-11-21-testing-django-migrations.md">Edit this page</a></small>
    </p>
  </header>

  <!-- Post Tags -->
  <!-- <ul class="c-tags">
    
    <li class="c-tag">python</li>
    
    <li class="c-tag">django</li>
    
  </ul> -->

  <!-- Content -->
  <div class="c-article__main">

    

    <div class="c-article__body" itemprop="articleBody">
      <p>Dear internet,</p>

<p>Today we have screwed up by applying a broken migration to the running production service and causing a massive outage for several hours… Because the rollback function was terribly broken as well.</p>

<p>As a result, we had to restore a backup that was made several hours ago, losing some new data.</p>


      <h2 id="why-did-it-happen">
        
        <a class="anchor" href="#why-did-it-happen">Why did it happen?</a>
        
      </h2>

<p>The easiest answer is just to say: “Because it is X’s fault! He is the author of this migration, he should learn how databases work”. But, it is counterproductive.</p>

<p>Instead, as a part of our <a href="https://sobolevn.me/2018/12/blameless-environment">“Blameless environment”</a> culture, we tend to put all the guilt on the CI. It was the CI who put the broken code into the <code class="language-plaintext highlighter-rouge">master</code> branch. So, we need to improve it!</p>

<p>We always <a href="https://sobolevn.me/2019/01/how-to-fix-a-bug">write post-mortems</a> for all massive incidents that we experience. And we write regression tests for all bugs, so they won’t happen again. But, this situation was different, since it was a broken migration that worked during the CI process, and it was hard or impossible to test with the current set of instruments.</p>

<p>So, let me explain the steps we took to solve this riddle.</p>


    
      <h2 id="existing-setup">
        
        <a class="anchor" href="#existing-setup">Existing setup</a>
        
      </h2>

<p>We use a very strict <a href="https://github.com/wemake-services/wemake-django-template"><code class="language-plaintext highlighter-rouge">django</code> project setup</a> with several quality checks for our migrations:</p>

<ol>
  <li>We write all data migration as typed functions in our main source code. Then we check everything with <code class="language-plaintext highlighter-rouge">mypy</code> and test as regular functions</li>
  <li>We lint migration files with <a href="https://github.com/wemake-services/wemake-python-styleguide"><code class="language-plaintext highlighter-rouge">wemake-python-styleguide</code></a>, it drastically reduces the possibility of bad code inside the migration files</li>
  <li>We use tests that automatically set up the database by applying all migrations before each session</li>
  <li>We use <a href="https://github.com/3YOURMIND/django-migration-linter"><code class="language-plaintext highlighter-rouge">django-migration-linter</code></a> to find migrations that are not suited for zero-time deployments</li>
  <li>And then we review the code by two senior people</li>
  <li>Then we test everything manually with the help of the review apps</li>
</ol>

<p>And somehow it is still not enough: our server was dead.</p>

<p>When writing the post-mortem for this bug, I spotted that data in our staging and production services were different. And that’s why our data migration crushed and left one of the core tables in the broken state.</p>

<p>So, how can we test migrations on some existing data?</p>


    
      <h2 id="django-test-migrations">
        
        <a class="anchor" href="#django-test-migrations">django-test-migrations</a>
        
      </h2>

<p>That’s where <a href="https://github.com/wemake-services/django-test-migrations"><code class="language-plaintext highlighter-rouge">django-test-migrations</code></a> comes in handy.</p>

<p>The idea of this project is simple:</p>

<ol>
  <li>Set some migration as a starting point</li>
  <li>Create some model’s data that you want to test</li>
  <li>Run the new migration that you are testing</li>
  <li>Assert the results!</li>
</ol>

<p>Let’s illustrate it with some code samples.
Full source code is <a href="https://github.com/wemake-services/django-test-migrations/tree/master/django_test_app">available here</a>.</p>

<p>Here’s the latest version of our model:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">SomeItem</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="s">"""We use this model for testing migrations."""</span>

    <span class="n">string_field</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">is_clean</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">BooleanField</span><span class="p">()</span>
</code></pre></div></div>

<p>This is a pretty simple model that serves only one purpose: to illustrate the problem. <code class="language-plaintext highlighter-rouge">is_clean</code> field is related to the contents of <code class="language-plaintext highlighter-rouge">string_field</code> in some manner.
While the <code class="language-plaintext highlighter-rouge">string_field</code> itself contains only regular text data.</p>

<p>Imagine that you have a data migration that looks like so:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_is_clean_item</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="s">'SomeItem'</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="s">"""
    Pure function to the actual migration.

    Ideally, it should be moved to ``main_app/logic/migrations``.
    But, as an example it is easier to read them together.
    """</span>
    <span class="k">return</span> <span class="s">' '</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">instance</span><span class="p">.</span><span class="n">string_field</span>

<span class="k">def</span> <span class="nf">_set_clean_flag</span><span class="p">(</span><span class="n">apps</span><span class="p">,</span> <span class="n">schema_editor</span><span class="p">):</span>
    <span class="s">"""
    Performs the data-migration.

    We can't import the ``SomeItem`` model directly as it may be a newer
    version than this migration expects.

    We are using ``.all()`` because
    we don't have a lot of ``SomeItem`` instances.
    In real-life you should not do that.
    """</span>
    <span class="n">SomeItem</span> <span class="o">=</span> <span class="n">apps</span><span class="p">.</span><span class="n">get_model</span><span class="p">(</span><span class="s">'main_app'</span><span class="p">,</span> <span class="s">'SomeItem'</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">SomeItem</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">all</span><span class="p">():</span>
        <span class="n">instance</span><span class="p">.</span><span class="n">is_clean</span> <span class="o">=</span> <span class="n">_is_clean_item</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
        <span class="n">instance</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">update_fields</span><span class="o">=</span><span class="p">[</span><span class="s">'is_clean'</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">_remove_clean_flags</span><span class="p">(</span><span class="n">apps</span><span class="p">,</span> <span class="n">schema_editor</span><span class="p">):</span>
    <span class="s">"""
    This is just a noop example of a rollback function.

    It is not used in our simple case,
    but it should be implemented for more complex scenarios.
    """</span>

<span class="k">class</span> <span class="nc">Migration</span><span class="p">(</span><span class="n">migrations</span><span class="p">.</span><span class="n">Migration</span><span class="p">):</span>
    <span class="n">dependencies</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s">'main_app'</span><span class="p">,</span> <span class="s">'0002_someitem_is_clean'</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="n">operations</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">migrations</span><span class="p">.</span><span class="n">RunPython</span><span class="p">(</span><span class="n">_set_clean_flag</span><span class="p">,</span> <span class="n">_remove_clean_flags</span><span class="p">),</span>
    <span class="p">]</span>
</code></pre></div></div>

<p>And here’s how we are going to test this migration. At first, we will have to set some migration as a starting point:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">old_state</span> <span class="o">=</span> <span class="n">migrator</span><span class="p">.</span><span class="n">before</span><span class="p">((</span><span class="s">'main_app'</span><span class="p">,</span> <span class="s">'0002_someitem_is_clean'</span><span class="p">))</span>
</code></pre></div></div>

<p>Then we have to get the model class. We cannot use direct <code class="language-plaintext highlighter-rouge">import</code> from <code class="language-plaintext highlighter-rouge">models</code> because the model might be different, since migrations change them from our stored definition:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">SomeItem</span> <span class="o">=</span> <span class="n">old_state</span><span class="p">.</span><span class="n">apps</span><span class="p">.</span><span class="n">get_model</span><span class="p">(</span><span class="s">'main_app'</span><span class="p">,</span> <span class="s">'SomeItem'</span><span class="p">)</span>
</code></pre></div></div>

<p>Then we need to create some data that we want to test:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># One instance will be `clean`, the other won't be:
</span><span class="n">SomeItem</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">string_field</span><span class="o">=</span><span class="s">'a'</span><span class="p">)</span> <span class="c1"># clean
</span><span class="n">SomeItem</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">string_field</span><span class="o">=</span><span class="s">'a b'</span><span class="p">)</span> <span class="c1"># contains whitespace, is not clean
</span></code></pre></div></div>

<p>Then we will run the migration that we are testing and get the new project state:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">new_state</span> <span class="o">=</span> <span class="n">migrator</span><span class="p">.</span><span class="n">after</span><span class="p">((</span><span class="s">'main_app'</span><span class="p">,</span> <span class="s">'0003_auto_20191119_2125'</span><span class="p">))</span>
<span class="n">SomeItem</span> <span class="o">=</span> <span class="n">new_state</span><span class="p">.</span><span class="n">apps</span><span class="p">.</span><span class="n">get_model</span><span class="p">(</span><span class="s">'main_app'</span><span class="p">,</span> <span class="s">'SomeItem'</span><span class="p">)</span>
</code></pre></div></div>

<p>And the last step: we need to make some assertions on the resulting data.
We have created two model instances before: one clean and one with the whitespace. So, let’s check that:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">assert</span> <span class="n">SomeItem</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span>
<span class="c1"># One instance is clean, the other is not:
</span><span class="k">assert</span> <span class="n">SomeItem</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">is_clean</span><span class="o">=</span><span class="bp">True</span><span class="p">).</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>
<span class="k">assert</span> <span class="n">SomeItem</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">is_clean</span><span class="o">=</span><span class="bp">False</span><span class="p">).</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>
</code></pre></div></div>

<p>And that’s how it works! Now we have an ability to test our schema and data transformations with ease. Complete test example:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">pytest</span><span class="p">.</span><span class="n">mark</span><span class="p">.</span><span class="n">django_db</span>
<span class="k">def</span> <span class="nf">test_main_migration0002</span><span class="p">(</span><span class="n">migrator</span><span class="p">):</span>
    <span class="s">"""Ensures that the second migration works."""</span>
    <span class="n">old_state</span> <span class="o">=</span> <span class="n">migrator</span><span class="p">.</span><span class="n">before</span><span class="p">((</span><span class="s">'main_app'</span><span class="p">,</span> <span class="s">'0002_someitem_is_clean'</span><span class="p">))</span>
    <span class="n">SomeItem</span> <span class="o">=</span> <span class="n">old_state</span><span class="p">.</span><span class="n">apps</span><span class="p">.</span><span class="n">get_model</span><span class="p">(</span><span class="s">'main_app'</span><span class="p">,</span> <span class="s">'SomeItem'</span><span class="p">)</span>
    <span class="c1"># One instance will be `clean`, the other won't be:
</span>    <span class="n">SomeItem</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">string_field</span><span class="o">=</span><span class="s">'a'</span><span class="p">)</span>
    <span class="n">SomeItem</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">string_field</span><span class="o">=</span><span class="s">'a b'</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">SomeItem</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">SomeItem</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">is_clean</span><span class="o">=</span><span class="bp">True</span><span class="p">).</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span>

    <span class="n">new_state</span> <span class="o">=</span> <span class="n">migrator</span><span class="p">.</span><span class="n">after</span><span class="p">((</span><span class="s">'main_app'</span><span class="p">,</span> <span class="s">'0003_auto_20191119_2125'</span><span class="p">))</span>
    <span class="n">SomeItem</span> <span class="o">=</span> <span class="n">new_state</span><span class="p">.</span><span class="n">apps</span><span class="p">.</span><span class="n">get_model</span><span class="p">(</span><span class="s">'main_app'</span><span class="p">,</span> <span class="s">'SomeItem'</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">SomeItem</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="c1"># One instance is clean, the other is not:
</span>    <span class="k">assert</span> <span class="n">SomeItem</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">is_clean</span><span class="o">=</span><span class="bp">True</span><span class="p">).</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>
</code></pre></div></div>

<p>By the way, we also support raw <a href="https://github.com/wemake-services/django-test-migrations#unittest"><code class="language-plaintext highlighter-rouge">unittest</code> cases</a>.</p>


    
      <h2 id="conclusion">
        
        <a class="anchor" href="#conclusion">Conclusion</a>
        
      </h2>

<p>Don’t be sure about your migrations. Test them!</p>

<p>You can test forward and rollback migrations and their <a href="https://github.com/wemake-services/django-test-migrations#testing-migrations-ordering">ordering</a> with the help of <code class="language-plaintext highlighter-rouge">django-test-migrations</code>. It is simple, friendly, and already works with the test framework of your choice.</p>

<p>I also want to say “thank you” to <a href="https://github.com/wemake-services/django-test-migrations#credits">these awesome people</a>. Without their work it would take me much longer to come up with the working solution.</p>

    </div>

    <hr>

    <div class="post-subscribe">
      
<!-- Add following div tag where you want show soopr share buttons -->
<div class="soopr-btn"></div>

<!-- Just before body tag add this line -->
<script async defer data-soopr-token="pt_3c7922127f46ef4aa2b340d1b94b2025" src="https://sdk.soopr.co/soopr.js"></script>
  
    </div>

    
    
    <div class="post-republish">
      <h4>Republished as:</h4>
      <ul>
      
        <li>
          <a class="c-article__repost" href="https://dev.to/wemake-services/testing-django-migrations-3288" target="_blank">
            
            dev.to <img class="emoji" title=":us:" alt=":us:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f1fa-1f1f8.png" height="20" width="20">
          </a>
        </li>
      
      </ul>
    </div>
    
  </div>

  <!-- Disqus comments view -->
  
</article>

  </div>
  <footer class="c-page__footer">
  <p>
    <i class="far fa-copyright"></i>
    <a href="https://sobolevn.me/about/">imrishi</a>
    2023,
    content licensed
    <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">
      CC BY-NC
    </a>,
    <a href="https://github.com/sobolevn/sobolevn.github.io" target="_blank">
      source code
    </a>
  </p>

  <p>
    <a href="mailto:r@rishi.im" alt="email">
      <i class="far fa-2x fa-envelope"></i>
    </a>
    <a href="https://github.com/sobolevn" alt="github">
      <i class="fab fa-2x fa-github"></i>
    </a>
    <a href="https://dev.to/sobolevn" alt="practicaldev">
      <i class="fab fa-2x fa-dev"></i>
    </a>
    <a href="https://medium.com/@sobolevn" alt="medium">
      <i class="fab fa-2x fa-medium"></i>
    </a>
    <a href="https://stackoverflow.com/users/4842742/sobolevn" alt="stackoverflow">
      <i class="fab fa-2x fa-stack-overflow"></i>
    </a>
  </p>
</footer>

</div>

    </main>

    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-66588818-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-66588818-1');
</script>

  </body>
</html>
