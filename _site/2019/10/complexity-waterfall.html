<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Favicon -->
  <link rel="apple-touch-icon" sizes="57x57" href="/assets/images/favicons/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/assets/images/favicons/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/assets/images/favicons/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/assets/images/favicons/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/assets/images/favicons/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/assets/images/favicons/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/assets/images/favicons/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/assets/images/favicons/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/images/favicons/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192"  href="/assets/images/favicons/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/assets/images/favicons/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/images/favicons/manifest.json">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/assets/images/favicons/ms-icon-144x144.png">
<meta name="theme-color" content="#ffffff">


  <!-- Meta information -->
  <title>Complexity Waterfall</title>
  <meta name="description"
        content="">
  <link rel="canonical"
        href="http://localhost:4000/2019/10/complexity-waterfall" />

  <!-- Open search scheme -->
  <link rel="search"
        type="application/opensearchdescription+xml"
        title="sobolevn.me"
        href="/opensearch.xml" />

  <!-- Feed -->
  <link rel="alternate" type="application/rss+xml" title="rishi raj's blog"
        href="/feed.xml" />

  <!-- Custom fonts -->
  <link href="https://fonts.googleapis.com/css?family=Merriweather:400,400i,900|Roboto+Mono:400,400i|Montserrat:400,800" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">

  <!-- Custom style -->
  <link rel="stylesheet" href="/css/main.css" />

  <!-- Global site tag (gtag.js) - Google Ads: 839642990 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=AW-839642990"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'AW-839642990');
  </script>
</head>


  <body>
    <main class="u-container">
      <div class="c-page">
  <header class="c-page__header">
  <h1><code>rishi raj's blog</code></h1>

  

  <nav role="navigation">
    <a href="/" role="menuitem">
      Blog
    </a>

    <span class="u-separate"></span>
    <a href="/talks/" role="menuitem">
      Talks
    </a>

    <span class="u-separate"></span>
    <a href="/activities/" role="menuitem">
      Activities
    </a>

    <span class="u-separate"></span>
    <a href="/about/" role="menuitem">
      About
    </a>

    <span class="u-separate"></span>
    <a href="/subscribe/" role="menuitem">
      Subscribe
    </a>
  </nav>
</header>

  <div class="c-page__main">
    <article class="c-article" itemscope="" itemtype="http://schema.org/BlogPosting">
  <header class="c-article__header">
    <h1 class="c-article__title" itemprop="name">Complexity Waterfall</h1>
    <p class="c-article__time">
      <small>
        <time datetime="2019-10-13T00:00:00+05:30" itemprop="datePublished">
          October 13, 2019
        </time>
      </small>
      <small><span class="reading-time" title="Estimated read time">
  
  
    19 mins
   read
</span>
</small>
      <small><a href="#discussion">Start a discussion</a></small>
      <small><a href="https://github.com/sobolevn/sobolevn.github.io/blob/master/_posts/2019-10-13-complexity-waterfall.md">Edit this page</a></small>
    </p>
  </header>

  <!-- Post Tags -->
  <!-- <ul class="c-tags">
    
    <li class="c-tag">python</li>
    
  </ul> -->

  <!-- Content -->
  <div class="c-article__main">

    

    <div class="c-article__body" itemprop="articleBody">
      <p><img src="https://imgur.com/r6SwSFy.png" alt="Logo"></p>

<p>When talking about “bad code” people almost certainly mean “complex code” among other popular problems. The thing about complexity is that it comes out of nowhere. You start your fairly simple project, then one day you find it in ruins. And no one knows how and when it happened.</p>

<p>But, this ultimately happens for a reason! Code complexity enters your codebase in two possible ways: with big chunks and incremental additions. And people are bad at reviewing and finding both of them.</p>

<p>When a big chunk of code comes in, the reviewer will be challenged to find the exact location where the code is complex and what to do about it. Then, the reviewer will have to prove the point: why this code is complex in the first place. And other developers might disagree. We all know these kinds of code reviews!</p>

<p><img src="https://imgur.com/c4HYCAi.png" alt="Number of lines for review and comments ratio"></p>

<p>The second way of complexity getting into your code is incremental addition: when you submit one or two lines to the existing function. And it is extremely hard to notice that your function was alright one commit ago, but now it is too complex. It takes a good portion of concentration, reviewing skill, and good code navigation practice to actually spot it. Most people (like me!) lack these skills and allow complexity to enter the codebase regularly.</p>

<p>So, what can be done to prevent your code from getting complex? We need to use automation! Let’s make a deep dive into the code complexity and ways to find and finally solve it.</p>

<p>In this article, I will guide you through places where complexity lives and how to fight it there. Then we will discuss how well written simple code and automation enable an opportunity of “Continuous Refactoring” and “Architecture on Demand” development styles.</p>


      <h2 id="complexity-explained">
        
        <a class="anchor" href="#complexity-explained">Complexity explained</a>
        
      </h2>

<p>One may ask: what exactly “code complexity” is? And while it sounds familiar, there are hidden obstacles in understanding the exact complexity location. Let’s start with the most primitive parts and then move to higher-level entities.</p>

<p>Remember, that this article is named “Complexity Waterfall”? I will show you how complexity from the simplest primitives overflows into the highest abstractions.</p>

<p>I will use <code class="language-plaintext highlighter-rouge">python</code> as the main language for my examples and <a href="https://github.com/wemake-services/wemake-python-styleguide"><code class="language-plaintext highlighter-rouge">wemake-python-styleguide</code></a> as the main linting tool to find the violations in my code and illustrate my point.</p>


    
      <h3 id="expressions">
        
        <a class="anchor" href="#expressions">Expressions</a>
        
      </h3>

<p>All your code consists of simple expressions like <code class="language-plaintext highlighter-rouge">a + 1</code> and <code class="language-plaintext highlighter-rouge">print(x)</code>. While expressions themself are simple, they might unnoticeably overflow your code with complexity at some point. Example: imagine that you have a dictionary that represents some <code class="language-plaintext highlighter-rouge">User</code> model and you use it like so:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">format_username</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">[</span><span class="s">'username'</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">user</span><span class="p">[</span><span class="s">'email'</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="s">'username'</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">user</span><span class="p">[</span><span class="s">'username'</span><span class="p">][:</span><span class="mi">12</span><span class="p">]</span> <span class="o">+</span> <span class="s">'...'</span>
    <span class="k">return</span> <span class="s">'@'</span> <span class="o">+</span> <span class="n">user</span><span class="p">[</span><span class="s">'username'</span><span class="p">]</span>
</code></pre></div></div>

<p>It looks pretty simple, doesn’t it? In fact, it contains two expression-based complexity issues. It <a href="https://wemake-python-stylegui.de/en/latest/pages/usage/violations/complexity.html#wemake_python_styleguide.violations.complexity.OverusedStringViolation">overuses <code class="language-plaintext highlighter-rouge">'username'</code> string</a>  and uses <a href="https://wemake-python-stylegui.de/en/latest/pages/usage/violations/best_practices.html#wemake_python_styleguide.violations.best_practices.MagicNumberViolation">magic number</a> <code class="language-plaintext highlighter-rouge">12</code> (why do we use this number in the first place, why not <code class="language-plaintext highlighter-rouge">13</code> or <code class="language-plaintext highlighter-rouge">10</code>?). It is hard to find these kinds of things all by yourself. Here’s how the better version would look like:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#: That's how many chars fit in the preview box.
</span><span class="n">LENGTH_LIMIT</span><span class="p">:</span> <span class="n">Final</span> <span class="o">=</span> <span class="mi">12</span>

<span class="k">def</span> <span class="nf">format_username</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="s">'username'</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">username</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">user</span><span class="p">[</span><span class="s">'email'</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">username</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">LENGTH_LIMIT</span><span class="p">:</span>  <span class="c1"># See? It is now documented
</span>        <span class="k">return</span> <span class="n">username</span><span class="p">[:</span><span class="n">LENGTH_LIMIT</span><span class="p">]</span> <span class="o">+</span> <span class="s">'...'</span>
    <span class="k">return</span> <span class="s">'@'</span> <span class="o">+</span> <span class="n">username</span>
</code></pre></div></div>

<p>There are other problems with expressions as well. We can also have <a href="https://wemake-python-stylegui.de/en/latest/pages/usage/violations/complexity.html#wemake_python_styleguide.violations.complexity.OverusedExpressionViolation">overused expressions</a>: when you use <code class="language-plaintext highlighter-rouge">some_object.some_attr</code> attribute everywhere instead of creating a new local variable. We can also have <a href="https://wemake-python-stylegui.de/en/latest/pages/usage/violations/complexity.html#wemake_python_styleguide.violations.complexity.TooManyConditionsViolation">too complex logic conditions</a> or <a href="https://wemake-python-stylegui.de/en/latest/pages/usage/violations/complexity.html#wemake_python_styleguide.violations.complexity.TooDeepAccessViolation">too deep dot access</a>.</p>

<p><strong>Solution</strong>: create new variables, arguments, or constants. Create and use new utility functions or methods if you have to.</p>


    
      <h3 id="lines">
        
        <a class="anchor" href="#lines">Lines</a>
        
      </h3>

<p>Expressions form code lines (please, do not confuse lines with statements: a single statement can take multiple lines and multiple statements might be located on a single line).</p>

<p>The first and the most obvious complexity metric for a line is its length. Yes, you heard it correctly. That’s why we (programmers) prefer to stick to the <code class="language-plaintext highlighter-rouge">80</code> chars-per-line rule and not because it was <a href="https://en.wikipedia.org/wiki/Characters_per_line">previously used</a> in teletypewriters. There are a lot of rumors about it lately, saying that it does not make any sense to use <code class="language-plaintext highlighter-rouge">80</code> chars for your code in 2k19. But, that’s obviously not true.</p>

<p>The idea is simple. You can have twice as much logic in a line with <code class="language-plaintext highlighter-rouge">160</code> chars as in a line with only <code class="language-plaintext highlighter-rouge">80</code> chars. That’s why this limit should be set and enforced. Remember, this is <em>not a stylistic choice</em>. It is a complexity metric!</p>

<p>The second main line complexity metric is less known and less used. It is called <a href="https://wemake-python-stylegui.de/en/latest/pages/usage/violations/complexity.html#wemake_python_styleguide.violations.complexity.LineComplexityViolation">Jones Complexity</a>. The idea behind it is simple: we count code (or <code class="language-plaintext highlighter-rouge">ast</code>) nodes in a single line to get its complexity. Let’s have a look at an example. These two lines are fundamentally different in terms of complexity but have the exact same width in chars:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="n">first_long_name_with_meaning</span><span class="p">,</span> <span class="n">second_very_long_name_with_meaning</span><span class="p">,</span> <span class="n">third</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">first</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">+</span> <span class="n">math</span><span class="p">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">matrix</span><span class="p">.</span><span class="n">trans</span><span class="p">(</span><span class="o">*</span><span class="n">matrix</span><span class="p">),</span> <span class="n">display</span><span class="p">.</span><span class="n">show</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</code></pre></div></div>

<p>Let’s count the nodes in the first one: one call, three names. Four nodes in total. The second one has twenty-one <code class="language-plaintext highlighter-rouge">ast</code> nodes. Well, the difference is clear. That’s why we use the Jones Complexity metric to allow the first long line and disallow the second one based on internal complexity, not just on raw length.</p>

<p>What to do with lines with a high Jones Complexity score?</p>

<p><strong>Solution</strong>: Split them into several lines or create new intermediate variables, utility functions, new classes, etc.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span>
    <span class="n">first</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">+</span> <span class="n">math</span><span class="p">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">matrix</span><span class="p">.</span><span class="n">trans</span><span class="p">(</span><span class="o">*</span><span class="n">matrix</span><span class="p">),</span>
    <span class="n">display</span><span class="p">.</span><span class="n">show</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<span class="p">)</span>
</code></pre></div></div>

<p>Now it is way more readable!</p>


    
      <h3 id="structures">
        
        <a class="anchor" href="#structures">Structures</a>
        
      </h3>

<p>The next step is analyzing language structures like <code class="language-plaintext highlighter-rouge">if</code>, <code class="language-plaintext highlighter-rouge">for</code>, <code class="language-plaintext highlighter-rouge">with</code>, etc., that are formed from lines and expressions. I have to say that this point is very language-specific. I’ll showcase several rules from this category using <code class="language-plaintext highlighter-rouge">python</code> as well.</p>

<p>We’ll start with <code class="language-plaintext highlighter-rouge">if</code>. What could be easier than a good old <code class="language-plaintext highlighter-rouge">if</code>? Actually, <code class="language-plaintext highlighter-rouge">if</code> starts to get tricky really fast. Here’s an example of how one can <a href="https://wemake-python-stylegui.de/en/latest/pages/usage/violations/complexity.html#wemake_python_styleguide.violations.complexity.TooManyElifsViolation">reimplement <code class="language-plaintext highlighter-rouge">switch</code></a> with <code class="language-plaintext highlighter-rouge">if</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">some</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
    <span class="p">...</span>
<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">some</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
    <span class="p">...</span>
<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">some</span><span class="p">,</span> <span class="nb">complex</span><span class="p">):</span>
    <span class="p">...</span>
<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">some</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
    <span class="p">...</span>
<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">some</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
    <span class="p">...</span>
<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">some</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
    <span class="p">...</span>
</code></pre></div></div>

<p>What’s the problem with this code? Well, imagine that we have tens of data types that should be covered including custom ones that we are not aware of yet. Then this complex code is an indicator that we are choosing the wrong pattern here. We need to refactor our code to fix this problem. For example, one can use <a href="https://github.com/thejohnfreeman/python-typeclasses"><code class="language-plaintext highlighter-rouge">typeclass</code>es</a> or <a href="https://docs.python.org/3/library/functools.html#functools.singledispatch"><code class="language-plaintext highlighter-rouge">singledispatch</code></a>. They do the same job, but nicer.</p>

<p><code class="language-plaintext highlighter-rouge">python</code> never ceases to amaze us. For example, you can write <code class="language-plaintext highlighter-rouge">with</code> with <a href="https://wemake-python-stylegui.de/en/latest/pages/usage/violations/consistency.html#wemake_python_styleguide.violations.consistency.MultipleContextManagerAssignmentsViolation">an arbitrary number of cases</a>, which is too mentally complex and confusing:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">first</span><span class="p">(),</span> <span class="n">second</span><span class="p">(),</span> <span class="n">third</span><span class="p">(),</span> <span class="n">fourth</span><span class="p">():</span>
    <span class="p">...</span>
</code></pre></div></div>

<p>You can also write comprehensions with any number of <a href="https://wemake-python-stylegui.de/en/latest/pages/usage/violations/consistency.html#wemake_python_styleguide.violations.consistency.MultipleIfsInComprehensionViolation"><code class="language-plaintext highlighter-rouge">if</code></a> and <a href="https://wemake-python-stylegui.de/en/latest/pages/usage/violations/complexity.html#wemake_python_styleguide.violations.complexity.TooManyForsInComprehensionViolation"><code class="language-plaintext highlighter-rouge">for</code></a> expressions, which can lead to complex, unreadable code:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span>
    <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">x_coords</span>
    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">y_coords</span>
    <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">z_coords</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">z</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">&lt;=</span> <span class="n">z</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">+</span> <span class="n">z</span> <span class="o">&lt;=</span> <span class="n">y</span>
    <span class="k">if</span> <span class="n">y</span> <span class="o">+</span> <span class="n">z</span> <span class="o">&lt;=</span> <span class="n">x</span>
<span class="p">]</span>
</code></pre></div></div>

<p>Compare it with the simple and readable version:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span>
    <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">itertools</span><span class="p">.</span><span class="n">product</span><span class="p">(</span><span class="n">x_coords</span><span class="p">,</span> <span class="n">y_coords</span><span class="p">,</span> <span class="n">z_coords</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">valid_coordinates</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
<span class="p">]</span>
</code></pre></div></div>

<p>You can also accidentally include <a href="https://wemake-python-stylegui.de/en/latest/pages/usage/violations/complexity.html#wemake_python_styleguide.violations.complexity.TooLongTryBodyViolation">multiple statements inside a <code class="language-plaintext highlighter-rouge">try</code></a> case, which is unsafe because it can raise and handle an exception in an unexpected place:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">try</span><span class="p">:</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">fetch_user</span><span class="p">()</span>  <span class="c1"># Can also fail, but don't expect that
</span>    <span class="n">log</span><span class="p">.</span><span class="n">save_user_operation</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="n">email</span><span class="p">)</span>  <span class="c1"># Can fail, and we know it
</span><span class="k">except</span> <span class="n">MyCustomException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
    <span class="p">...</span>
</code></pre></div></div>

<p>And that’s not even 10% of cases that can and will go wrong with your <code class="language-plaintext highlighter-rouge">python</code> code. There are many, many <a href="https://wemake-python-stylegui.de/en/latest/pages/usage/violations/complexity.html#summary">more edge cases</a> that should be tracked and analyzed.</p>

<p><strong>Solution</strong>: The only possible solution is to use <a href="https://wemake-python-stylegui.de">a good linter</a> for the language of your choice. And refactor complex places that this linter highlights. Otherwise, you will have to reinvent the wheel and set custom policies for the exact same problems.</p>


    
      <h3 id="functions">
        
        <a class="anchor" href="#functions">Functions</a>
        
      </h3>

<p>Expressions, statements, and structures form functions. Complexity from these entities flows into functions. And that’s where things start to get intriguing. Because functions have literally dozens of complexity metrics: both good and bad.</p>

<p>We will start with the most known ones: <a href="https://en.wikipedia.org/wiki/Cyclomatic_complexity">cyclomatic complexity</a> and a function’s length measured in code lines. Cyclomatic complexity indicates how many turns your execution flow can take: it is almost equal to the number of unit tests that are required to fully cover the source code. It is a good metric because it respects the semantics and helps the developer to do the refactoring. On the other hand, a function’s length is a bad metric. It conflicts with the previously explained Jones Complexity metric since we already know: multiple lines are easier to read than one big line with everything inside. We will concentrate on good metrics only and ignore bad ones.</p>

<p>Based on my experience, multiple useful complexity metrics should be counted instead of regular function’s length:</p>

<ul>
  <li>Number of function decorators; lower is better</li>
  <li>Number of arguments; lower is better</li>
  <li>Number of annotations; higher is better</li>
  <li>Number of local variables; lower is better</li>
  <li>Number of returns, yields, awaits; lower is better</li>
  <li>Number of statements and expressions; lower is better</li>
</ul>

<p>The combination of all these checks really allows you to write simple functions (all rules are also applied to methods as well).</p>

<p>When you try to do some nasty things with your function, you will surely break at least one metric. And this will disappoint our linter and blow your build. As a result, your function will be saved.</p>

<p><strong>Solution</strong>: when one function is too complex, the only solution you have is to split this function into multiple ones.</p>


    
      <h3 id="classes">
        
        <a class="anchor" href="#classes">Classes</a>
        
      </h3>

<p>The next level of abstraction after functions are classes. And as you already guessed they are even more complex and fluid than functions. Because classes might contain multiple functions inside (that are called methods) and have other unique features like inheritance and mixins, class-level attributes, and class-level decorators. So, we have to check all methods as functions and the class body itself.</p>

<p>For classes we have to measure the following metrics:</p>

<ul>
  <li>Number of class-level decorators; lower is better</li>
  <li>Number of base classes; lower is better</li>
  <li>Number of class-level public attributes; lower is better</li>
  <li>Number of instance-level public attributes; lower is better</li>
  <li>Number of methods; lower is better</li>
</ul>

<p>When any of these is overly complicated - we have to ring the alarm and fail the build!</p>

<p><strong>Solution</strong>: refactor your failed class! Split one existing complex class into several simple ones or create new utility functions and use composition.</p>

<p>Notable mention: one can also track <a href="https://github.com/mschwager/cohesion">cohesion</a> and coupling <a href="https://stackoverflow.com/questions/3085285/difference-between-cohesion-and-coupling">metrics</a> to validate the complexity of your OOP design.</p>


    
      <h3 id="modules">
        
        <a class="anchor" href="#modules">Modules</a>
        
      </h3>

<p>Modules do contain multiple statements, functions, and classes. And as we might have already mentioned we usually advise to split functions and classes into new ones. That’s why we have to keep an eye on module complexity: it literally flows into modules from classes and functions.</p>

<p>To analyze the complexity of the module we have to check:</p>

<ul>
  <li>The number of imports and imported names; lower is better</li>
  <li>The number of classes and functions; lower is better</li>
  <li>The average complexity of functions and classes inside; lower is better</li>
</ul>

<p>What do we do in the case of a complex module?</p>

<p><strong>Solution</strong>: yes, you got it right. We split one module into several.</p>


    
      <h3 id="packages">
        
        <a class="anchor" href="#packages">Packages</a>
        
      </h3>

<p>Packages contain multiple modules. Luckily, that’s all they do.</p>

<p>So, the number of modules in a package can soon start to be too large, so you will end up with too many of them. And it is the only complexity that can be found with packages.</p>

<p><strong>Solution</strong>: you have to split packages into sub-packages and packages of different levels.</p>


    
      <h2 id="complexity-waterfall-effect">
        
        <a class="anchor" href="#complexity-waterfall-effect">Complexity Waterfall effect</a>
        
      </h2>

<p>We now have covered almost all possible types of abstractions in your codebase. What have we learned from it? The main takeaway, for now, is that most problems can be solved with ejecting complexity to the same or upper abstraction level.</p>

<p><img src="https://imgur.com/OQLTbjV.png" alt="Complexity Waterfall"></p>

<p>This leads us to the most important idea of this article: do not let your code be overflowed with the complexity. I will give several examples of how it usually happens.</p>

<p>Imagine that you are implementing a new feature. And that’s the only change you make:</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gi">+++ if user.is_active and user.has_sub() and sub.is_due(tz.now() + delta):
</span><span class="gd">--- if user.is_active and user.has_sub():
</span></code></pre></div></div>

<p>Looks ok, I would pass this code on review. And nothing bad would happen. But, the point I am missing is that complexity overflowed this line! That’s what <code class="language-plaintext highlighter-rouge">wemake-python-styleguide</code> will report:</p>

<p><img src="https://imgur.com/qjPTkH5.png" alt="wemake-python-styleguide-output"></p>

<p>Ok, we now have to solve this complexity. Let’s make a new variable:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Product</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="p">...</span>

    <span class="k">def</span> <span class="nf">can_be_purchased</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="p">...</span>

        <span class="n">is_sub_paid</span> <span class="o">=</span> <span class="n">sub</span><span class="p">.</span><span class="n">is_due</span><span class="p">(</span><span class="n">tz</span><span class="p">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">delta</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user</span><span class="p">.</span><span class="n">is_active</span> <span class="ow">and</span> <span class="n">user</span><span class="p">.</span><span class="n">has_sub</span><span class="p">()</span> <span class="ow">and</span> <span class="n">is_sub_paid</span><span class="p">:</span>
            <span class="p">...</span>

        <span class="p">...</span>

<span class="p">...</span>
</code></pre></div></div>

<p>Now, the line complexity is solved. But, wait a minute. What if our function has too many variables now? Because we have created a new variable without checking their number inside the function first. In this case we will have to split this method into several ones like so:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Product</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="p">...</span>

    <span class="k">def</span> <span class="nf">can_be_purchased</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="p">...</span>

        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">_has_paid_sub</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">sub</span><span class="p">,</span> <span class="n">delta</span><span class="p">):</span>
            <span class="p">...</span>

        <span class="p">...</span>

    <span class="k">def</span> <span class="nf">_has_paid_sub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">sub</span><span class="p">,</span> <span class="n">delta</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">is_sub_paid</span> <span class="o">=</span> <span class="n">sub</span><span class="p">.</span><span class="n">is_due</span><span class="p">(</span><span class="n">tz</span><span class="p">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">delta</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user</span><span class="p">.</span><span class="n">is_active</span> <span class="ow">and</span> <span class="n">user</span><span class="p">.</span><span class="n">has_sub</span><span class="p">()</span> <span class="ow">and</span> <span class="n">is_sub_paid</span>

<span class="p">...</span>
</code></pre></div></div>

<p>Now we are done! Right? No, because we now have to check the complexity of the <code class="language-plaintext highlighter-rouge">Product</code> class. Imagine, that it now has too many methods since we have created a new <code class="language-plaintext highlighter-rouge">_has_paid_sub</code> one.</p>

<p>Ok, we run our linter to check the complexity again. And turns out our <code class="language-plaintext highlighter-rouge">Product</code> class is indeed too complex right now. Our actions? We split it into several classes!</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Policy</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="p">...</span>

<span class="k">class</span> <span class="nc">SubcsriptionPolicy</span><span class="p">(</span><span class="n">Policy</span><span class="p">):</span>
    <span class="p">...</span>

    <span class="k">def</span> <span class="nf">can_be_purchased</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="p">...</span>

        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">_has_paid_sub</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">sub</span><span class="p">,</span> <span class="n">delta</span><span class="p">):</span>
            <span class="p">...</span>

        <span class="p">...</span>

    <span class="k">def</span> <span class="nf">_has_paid_sub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">sub</span><span class="p">,</span> <span class="n">delta</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">is_sub_paid</span> <span class="o">=</span> <span class="n">sub</span><span class="p">.</span><span class="n">is_due</span><span class="p">(</span><span class="n">tz</span><span class="p">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">delta</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user</span><span class="p">.</span><span class="n">is_active</span> <span class="ow">and</span> <span class="n">user</span><span class="p">.</span><span class="n">has_sub</span><span class="p">()</span> <span class="ow">and</span> <span class="n">is_sub_paid</span>

<span class="k">class</span> <span class="nc">Product</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">_purchasing_policy</span><span class="p">:</span> <span class="n">Policy</span>

    <span class="p">...</span>

<span class="p">...</span>
</code></pre></div></div>

<p>Please, tell me that it is the last iteration! Well, I am sorry, but we now have to check the module complexity. And guess what? We now have too many module members. So, we have to split modules into separate ones! Then we check the package complexity. And also possibly split it into several sub-packages.</p>

<p>Have you seen it? Because of the well-defined complexity rules our single-line modification turned out to be a huge refactoring session with several new modules and classes. And we haven’t made a single decision ourselves: all our refactoring goals were driven by the internal complexity and the linter that reveals it.</p>

<p>That’s what I call a “Continuous Refactoring” process. You are forced to do the refactoring. Always.</p>

<p>This process also has one interesting consequence. It allows you to have “Architecture on Demand”. Let me explain. With “Architecture on Demand” philosophy you always start small. For example with a single <code class="language-plaintext highlighter-rouge">logic/domains/user.py</code> file. And you start to put everything <code class="language-plaintext highlighter-rouge">User</code> related there. Because at this moment you probably don’t know what your architecture will look like. And you don’t care. You only have like three functions.</p>

<p>Some people fall into architecture vs code complexity trap. They can overly-complicate their architecture from the very start with the full repository/service/domain layers. Or they can overly-complicate the source code with no clear separation. Struggle and live like this for years (if they will be able to live for years with the code like this!).</p>

<p>The “Architecture on Demand” concept solves these problems. You start small, when the time comes - you split and refactor things:</p>

<ol>
  <li>You start with <code class="language-plaintext highlighter-rouge">logic/domains/user.py</code> and put everything in there</li>
  <li>Later you create <code class="language-plaintext highlighter-rouge">logic/domains/user/repository.py</code> when you have enough database related stuff</li>
  <li>Then you split it into <code class="language-plaintext highlighter-rouge">logic/domains/user/repository/queries.py</code> and <code class="language-plaintext highlighter-rouge">logic/domains/user/repository/commands.py</code> when the complexity tells you to do so</li>
  <li>Then you create <code class="language-plaintext highlighter-rouge">logic/domains/user/services.py</code> with <code class="language-plaintext highlighter-rouge">http</code> related stuff</li>
  <li>Then you create a new module called <code class="language-plaintext highlighter-rouge">logic/domains/order.py</code>
</li>
  <li>And so on and so on</li>
</ol>

<p>That’s it. It is a perfect tool to balance your architecture and code complexity. And get as much architecture as you truly need at the moment.</p>


    
      <h2 id="conclusion">
        
        <a class="anchor" href="#conclusion">Conclusion</a>
        
      </h2>

<p>A good linter does much more than finding missing commas and bad quotes. A good linter allows you to rely on it with architecture decisions and help you with the refactoring process.</p>

<p>For example, <code class="language-plaintext highlighter-rouge">wemake-python-styleguide</code> might help you with the <code class="language-plaintext highlighter-rouge">python</code> source code complexity, it allows you to:</p>

<ul>
  <li>Successfully fight the complexity at all levels</li>
  <li>Enforce the enormous amount of naming standards, best practices, and consistency checks</li>
  <li>Easily integrate it into a legacy code base with the help of <a href="https://wemake-python-stylegui.de/en/latest/pages/usage/integrations/legacy.html"><code class="language-plaintext highlighter-rouge">diff</code> option</a> or <a href="https://wemake-python-stylegui.de/en/latest/pages/usage/integrations/flakehell.html"><code class="language-plaintext highlighter-rouge">flakehell</code></a> tool, so old violation will be forgiven, but new ones won’t be allowed</li>
  <li>Enable it into your <a href="">CI</a>, even as a <a href="https://github.com/marketplace/actions/wemake-python-styleguide">Github Action</a>
</li>
</ul>

<p>Do not let the complexity to overflow your code, <a href="https://github.com/wemake-services/wemake-python-styleguide">use a good linter</a>!</p>

    </div>

    <hr>

    <div class="post-subscribe">
      <h2>
        <a href="https://sobolevn.me/subscribe">
          Subscribe to my blog if you want more
        </a>
      </h2>
    </div>

    
    
    <div class="post-republish">
      <h4>Republished as:</h4>
      <ul>
      
        <li>
          <a class="c-article__repost" href="https://habr.com/ru/post/472876/" target="_blank">
            
            habr.com <img class="emoji" title=":us:" alt=":us:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f1fa-1f1f8.png" height="20" width="20">
          </a>
        </li>
      
        <li>
          <a class="c-article__repost" href="https://dev.to/wemake-services/complexity-waterfall-n2d" target="_blank">
            
            dev.to <img class="emoji" title=":us:" alt=":us:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f1fa-1f1f8.png" height="20" width="20">
          </a>
        </li>
      
      </ul>
    </div>
    
  </div>

  <!-- Disqus comments view -->
  
</article>

  </div>
  <footer class="c-page__footer">
  <p>
    <i class="far fa-copyright"></i>
    <a href="https://sobolevn.me/about/">imrishi</a>
    2023,
    content licensed
    <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">
      CC BY-NC
    </a>,
    <a href="https://github.com/sobolevn/sobolevn.github.io" target="_blank">
      source code
    </a>
  </p>

  <p>
    <a href="mailto:r@rishi.im" alt="email">
      <i class="far fa-2x fa-envelope"></i>
    </a>
    <a href="https://github.com/sobolevn" alt="github">
      <i class="fab fa-2x fa-github"></i>
    </a>
    <a href="https://dev.to/sobolevn" alt="practicaldev">
      <i class="fab fa-2x fa-dev"></i>
    </a>
    <a href="https://medium.com/@sobolevn" alt="medium">
      <i class="fab fa-2x fa-medium"></i>
    </a>
    <a href="https://stackoverflow.com/users/4842742/sobolevn" alt="stackoverflow">
      <i class="fab fa-2x fa-stack-overflow"></i>
    </a>
  </p>
</footer>

</div>

    </main>

    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-66588818-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-66588818-1');
</script>

  </body>
</html>
